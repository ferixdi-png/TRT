# üìä LOG ANALYSIS REPORT

**–î–∞—Ç–∞:** 2026-01-21  
**–í–µ—Ä—Å–∏—è:** Production  
**–°–æ–±—ã—Ç–∏–µ:** –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (gen_type ‚Üí model ‚Üí params ‚Üí generate)

---

## ‚úÖ –û–ë–©–ò–ô –°–¢–ê–¢–£–°

**–í–µ—Ä–¥–∏–∫—Ç:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **–°–¢–ê–ë–ò–õ–¨–ù–û** –±–µ–∑ –æ—à–∏–±–æ–∫

- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (outcome=success)
- ‚úÖ KIE API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (latency ~80-118ms –∑–∞ poll)
- ‚úÖ Free quota —Å–∏—Å—Ç–µ–º–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç (5/5 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∑–∞ ~25 —Å–µ–∫—É–Ω–¥
- ‚ö†Ô∏è –ï—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üîç –î–ï–¢–ê–õ–¨–ù–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

### Handler Latency

| Handler | Latency (ms) | –°—Ç–∞—Ç—É—Å |
|---------|--------------|--------|
| button_callback (gen_type) | 519 | ‚úÖ OK |
| button_callback (select_model) | 1284 | ‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–æ |
| input_parameters | 127 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| button_callback (set_param) | 267 | ‚úÖ OK |
| button_callback (confirm_param) | 260 | ‚úÖ OK |
| button_callback (confirm_generate) | 30435 | ‚è±Ô∏è +–≥–µ–Ω–µ—Ä–∞—Ü–∏—è |

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –°—Ä–µ–¥–Ω—è—è latency (–±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏): **491ms**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è latency (–±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏): **1284ms** ‚ö†Ô∏è
- –û–±—â–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: **~25 —Å–µ–∫—É–Ω–¥** ‚úÖ

### KIE Polling –°—Ç—Ä–∞—Ç–µ–≥–∏—è

```
Attempt 1: 118ms, delay 3s
Attempt 2: 83ms, delay 4.5s (elapsed 3.1s)
Attempt 3: 80ms, delay 6.75s (elapsed 7.7s)
Attempt 4: 81ms, delay 10.125s (elapsed 14.5s)
Attempt 5: 80ms, SUCCESS (elapsed 24.7s)
```

**–û—Ü–µ–Ω–∫–∞:**
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è polling: ~80-118ms
- ‚ö†Ô∏è –ù–µ—Ç —è–≤–Ω–æ–≥–æ max_timeout
- ‚ö†Ô∏è –ù–µ—Ç —è–≤–Ω–æ–≥–æ max_attempts

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. SESSION_GET: –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –í—ã–∑–æ–≤—ã (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–í—Å–µ–≥–æ SESSION_GET –∑–∞ –æ–¥–Ω—É –≥–µ–Ω–µ—Ä–∞—Ü–∏—é: 40 –≤—ã–∑–æ–≤–æ–≤
```

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
- –í—ã–±–æ—Ä gen_type: 2 –≤—ã–∑–æ–≤–∞
- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏: 11 –≤—ã–∑–æ–≤–æ–≤ ‚ö†Ô∏è
- –í–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: 6 –≤—ã–∑–æ–≤–æ–≤
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: 6 –≤—ã–∑–æ–≤–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: 5 –≤—ã–∑–æ–≤–æ–≤

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

–í `bot_kie.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤** `session_store.get(user_id)` –≤–º–µ—Å—Ç–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `get_session_cached()`:

```python
# ‚ùå –ü–õ–û–•–û (40 —Ä–∞–∑):
session = session_store.get(user_id)

# ‚úÖ –•–û–†–û–®–û (1 —Ä–∞–∑ per update):
session = get_session_cached(context, session_store, user_id, update_id)
```

**–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**
- `bot_kie.py` - —Å—Ç—Ä–æ–∫–∏: 16375, 16425, 16490, 16547, 16594
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**

–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `session_store.get(user_id)` –Ω–∞:
```python
from app.session_store import get_session_cached

# –í –∫–∞–∂–¥–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ:
update_id = update.update_id if update else None
session = get_session_cached(
    context=context,
    store=session_store,
    user_id=user_id,
    update_id=update_id
)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ —Å **40 –¥–æ ~5-7**
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ latency –Ω–∞ **50-100ms** –∑–∞ —Ü–∏–∫–ª
- –≠–∫–æ–Ω–æ–º–∏—è GitHub API rate limits

---

### 2. FREE_COUNTER_VIEW: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–í—Å–µ–≥–æ –≤—ã–∑–æ–≤–æ–≤: 6
- 5 —Ä–∞–∑: remaining=1, used_today=4 (–æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ!)
- 1 —Ä–∞–∑: remaining=0, used_today=5 (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ)
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

–§—É–Ω–∫—Ü–∏—è `show_free_counter()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ** wizard'–∞, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ `app/helpers/free_tools.py`:

```python
def show_free_counter(user_id: int, sku_id: str, context: Any = None) -> str:
    """Show free generation counter, but only if changed."""
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    current_remaining = get_free_remaining(user_id, sku_id)
    limit_per_day = FREE_MODEL_LIMITS_PER_DAY.get(sku_id, 5)
    used_today = limit_per_day - current_remaining
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –≤ context.user_data
    if context and hasattr(context, "user_data"):
        cache_key = f"_free_counter_{sku_id}"
        last_state = context.user_data.get(cache_key)
        
        current_state = (current_remaining, used_today)
        
        # –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞
        if last_state == current_state:
            return ""  # –ò–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        context.user_data[cache_key] = current_state
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –ª–æ–≥–∏—Ä—É–µ–º
    # ... existing code ...
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- –£–±—Ä–∞—Ç—å **4 –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –≤—ã–∑–æ–≤–∞ –∏–∑ 6**
- –ú–µ–Ω—å—à–µ —Å–ø–∞–º–∞ –≤ –ª–æ–≥–∞—Ö
- –ß–∏—â–µ UI (–Ω–µ –º–µ–ª—å–∫–∞–µ—Ç –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

---

## üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 3. PRICE_RESOLVED: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –í—ã–∑–æ–≤—ã (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
–í—Å–µ–≥–æ –≤—ã–∑–æ–≤–æ–≤: 5
- 2 —Ä–∞–∑–∞: params={}
- 3 —Ä–∞–∑–∞: params={'prompt': '–∫–æ—Ç–∏–∫', 'aspect_ratio': '16:9'}
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

–§—É–Ω–∫—Ü–∏—è `resolve_price()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**

–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à –≤ `app/helpers/price_resolver.py`:

```python
def resolve_price_cached(
    model_id: str,
    mode_index: int,
    params: Dict[str, Any],
    context: Any = None,
    update_id: int | None = None
) -> PriceResult:
    """Resolve price with per-update caching."""
    
    if context and hasattr(context, "user_data") and update_id:
        cache_key = "_price_cache"
        cache = context.user_data.get(cache_key, {})
        
        # –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –∫—ç—à–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        cache_hash = (model_id, mode_index, tuple(sorted(params.items())))
        
        if cache.get("update_id") == update_id and cache.get("hash") == cache_hash:
            return cache["result"]
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—É
        result = resolve_price(model_id, mode_index, params)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        context.user_data[cache_key] = {
            "update_id": update_id,
            "hash": cache_hash,
            "result": result
        }
        
        return result
    
    # –ë–µ–∑ –∫—ç—à–∞ ‚Äî –æ–±—ã—á–Ω—ã–π –≤—ã–∑–æ–≤
    return resolve_price(model_id, mode_index, params)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ —Å **5 –¥–æ 1-2**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è CPU (—Ä–∞—Å—á—ë—Ç –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—è–∂–µ–ª–æ–µ)

---

### 4. KIE Polling: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¢–∞–π–º–∞—É—Ç–æ–≤ (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–ü—Ä–æ–±–ª–µ–º–∞:**

–ù–µ—Ç —è–≤–Ω–æ–≥–æ `max_timeout` –∏ `max_attempts` –¥–ª—è polling. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏, —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º polling.

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
# universal_engine.py
while True:
    result = kie_client.get_task_status(task_id)
    if result.state == "success":
        break
    await asyncio.sleep(delay)
    delay *= 1.5  # Exponential backoff
```

**–†–µ—à–µ–Ω–∏–µ:**

–î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ `app/engine/universal_engine.py`:

```python
MAX_POLL_TIMEOUT = 60  # seconds
MAX_POLL_ATTEMPTS = 10

start_time = time.time()
attempt = 0

while True:
    attempt += 1
    elapsed = time.time() - start_time
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞
    if elapsed > MAX_POLL_TIMEOUT:
        raise TimeoutError(f"KIE task {task_id} exceeded {MAX_POLL_TIMEOUT}s timeout")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫
    if attempt > MAX_POLL_ATTEMPTS:
        raise RuntimeError(f"KIE task {task_id} exceeded {MAX_POLL_ATTEMPTS} attempts")
    
    result = kie_client.get_task_status(task_id)
    if result.state == "success":
        break
    
    await asyncio.sleep(min(delay, 15))  # Cap delay at 15s
    delay *= 1.5
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –Ω–∞ –¥–æ–ª–≥–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏—è—Ö
- –ë–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –ß–∏—Å—Ç—ã–µ error logs –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å KIE API

---

## üü¢ –ù–ò–ó–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 5. Latency Monitoring (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–ü—Ä–æ–±–ª–µ–º–∞:**

–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π latency (1284ms –Ω–∞ select_model ‚Äî —ç—Ç–æ –º–Ω–æ–≥–æ).

**–†–µ—à–µ–Ω–∏–µ:**

–î–æ–±–∞–≤–∏—Ç—å –≤ `bot_kie.py` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `HANDLER_LATENCY` –ª–æ–≥–∞:

```python
# –ü–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è latency:
if duration_ms > 1000 and handler != "button_callback":
    logger.warning(
        "‚ö†Ô∏è HIGH_LATENCY handler=%s duration_ms=%s threshold=1000",
        handler,
        duration_ms
    )
    structured_log(
        correlation_id=correlation_id,
        user_id=user_id,
        action="HIGH_LATENCY_ALERT",
        stage="PERFORMANCE",
        param={"handler": handler, "duration_ms": duration_ms},
        outcome="alert",
        error_code="LATENCY_THRESHOLD_EXCEEDED"
    )
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –¥–æ –∂–∞–ª–æ–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–°–†–û–ß–ù–û)

1. **SESSION_GET –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî ~2 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `session_store.get()` –Ω–∞ `get_session_cached()`
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫—ç—à–∞
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å metrics —Å–Ω–∏–∂–µ–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤

2. **FREE_COUNTER –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** ‚Äî ~1 —á–∞—Å —Ä–∞–±–æ—Ç—ã
   - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `show_free_counter()`
   - [ ] –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å last_state –≤ context.user_data
   - [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞

### –§–∞–∑–∞ 2: –°—Ä–µ–¥–Ω–∏–µ –£–ª—É—á—à–µ–Ω–∏—è (1-2 –¥–Ω—è)

3. **PRICE_RESOLVED –∫—ç—à** ‚Äî ~1.5 —á–∞—Å–∞
   - [ ] –°–æ–∑–¥–∞—Ç—å `resolve_price_cached()` —Ñ—É–Ω–∫—Ü–∏—é
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö
   - [ ] –î–æ–±–∞–≤–∏—Ç—å metrics

4. **KIE polling —Ç–∞–π–º–∞—É—Ç—ã** ‚Äî ~2 —á–∞—Å–∞
   - [ ] –î–æ–±–∞–≤–∏—Ç—å MAX_POLL_TIMEOUT –∏ MAX_POLL_ATTEMPTS
   - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å timeout errors
   - [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏

### –§–∞–∑–∞ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

5. **Latency monitoring** ‚Äî ~1 —á–∞—Å
   - [ ] –î–æ–±–∞–≤–∏—Ç—å HIGH_LATENCY_ALERT –ª–æ–≥–∏
   - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å threshold (1000ms)
   - [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Render metrics

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| SESSION_GET per cycle | 40 | 5-7 | **85% ‚Üì** |
| FREE_COUNTER calls | 6 | 2 | **66% ‚Üì** |
| PRICE_RESOLVED calls | 5 | 1-2 | **60% ‚Üì** |
| –°—Ä–µ–¥–Ω—è—è latency | 491ms | 400-450ms | **10-20% ‚Üì** |
| Logs per generation | ~200 | ~150 | **25% ‚Üì** |

---

## üéØ –î–û–õ–ì–û–°–†–û–ß–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **Redis –¥–ª—è session store** - –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
2. **Rate limiting –Ω–∞ KIE API** - –∑–∞—â–∏—Ç–∞ –æ—Ç burst requests
3. **CDN –¥–ª—è media** - –∫—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
4. **APM –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - Sentry/DataDog –¥–ª—è production insights
5. **Graceful degradation** - fallback –Ω–∞ slower models –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

---

## ‚úÖ –í–´–í–û–î–´

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ** –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.

**–ì–ª–∞–≤–Ω—ã–µ –±–æ—Ç—Ç–ª–Ω–µ–∫–∏:**
- ‚ùå –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ SESSION_GET –≤—ã–∑–æ–≤—ã (40 –≤–º–µ—Å—Ç–æ 5)
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ FREE_COUNTER –ø–æ–∫–∞–∑–∞ (5 —Ä–∞–∑ –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ)
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout –∑–∞—â–∏—Ç—ã –Ω–∞ KIE polling

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∏–µ latency –Ω–∞ 10-20%
- ‚úÖ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –Ω–∞ 25%
- ‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ UX (–º–µ–Ω—å—à–µ –º–µ–ª—å–∫–∞–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–∞)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –Ω–∞ –¥–æ–ª–≥–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏—è—Ö

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. üî¥ SESSION_GET –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî **–°–†–û–ß–ù–û**
2. üî¥ FREE_COUNTER –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Äî **–°–†–û–ß–ù–û**
3. üü° PRICE_RESOLVED –∫—ç—à ‚Äî —Å—Ä–µ–¥–Ω–∏–π
4. üü° KIE —Ç–∞–π–º–∞—É—Ç—ã ‚Äî —Å—Ä–µ–¥–Ω–∏–π
5. üü¢ Latency monitoring ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

---

**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–î–∞—Ç–∞:** 2026-01-21  
**–í–µ—Ä—Å–∏—è:** 1.0
