# üîê –°–∏—Å—Ç–µ–º–∞ –ü—Ä–æ–≤–µ—Ä–∫–∏ –ü–ª–∞—Ç–µ–∂–µ–π –°–ë–ü (Fast Bank Transfer)

## üìã –û–±–∑–æ—Ä

–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –°–ë–ü —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OCR (Optical Character Recognition) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤.

**–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∏–¥—ã–≤–∞–µ—Ç —á–µ–∫/—Å–∫—Ä–∏–Ω—à–æ—Ç –ø–ª–∞—Ç–µ–∂–∞, —Å–∏—Å—Ç–µ–º–∞ **–°–¢–†–û–ì–û –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**:
1. ‚úÖ **–†–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É** - –Ω–∞—Ö–æ–¥–∏—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É –≤ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ (¬±5% –¥–æ–ø—É—Å–∫–∞)
2. ‚úÖ **–†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è
3. ‚úÖ **–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞** - –∏—â–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "—É—Å–ø–µ—à–Ω–æ", "–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ", "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
4. ‚úÖ **–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç** - –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üîç –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø–ª–∞—Ç–µ–∂–∞

### 1Ô∏è‚É£ **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)**

```python
async def analyze_payment_screenshot(
    image_data: bytes,           # –°–∫—Ä–∏–Ω—à–æ—Ç –≤ –±–∞–π—Ç–∞—Ö
    expected_amount: float,      # –û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞
    expected_phone: str = None   # –û–∂–∏–¥–∞–µ–º—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
) -> dict:  # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
```

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** Pytesseract —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- üá∑üá∫ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–æ—Å–Ω–æ–≤–Ω–æ–π)
- üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ (fallback)

### 2Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã (¬±5% –¥–æ–ø—É—Å–∫)**

–°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç —á–∏—Å–ª–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü–∞—Ç—Ç–µ—Ä–Ω | –ü—Ä–∏–º–µ—Ä |
|-----------|---------|--------|
| **–í–´–°–û–ö–ò–ô** | –° —Å–∏–º–≤–æ–ª–æ–º ‚ÇΩ –∏–ª–∏ "—Ä—É–±" | `500 ‚ÇΩ`, `500 —Ä—É–±` |
| **–í–´–°–û–ö–ò–ô** | –†—è–¥–æ–º —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ | `–°—É–º–º–∞: 500`, `–ü–µ—Ä–µ–≤–æ–¥ 500` |
| **–°–†–ï–î–ù–ò–ô** | –ö—Ä—É–ø–Ω—ã–µ —á–∏—Å–ª–∞ | `500` |

**–°—Ç—Ä–æ–≥–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**
- ‚úÖ –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ ‚â§ 5% - **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û**
- ‚ö†Ô∏è –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ 5%-10% - **–î–û–ü–£–°–ö–ê–ï–¢–°–Ø** (—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- ‚ùå –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > 10% - **–û–¢–ö–õ–û–ù–ï–ù–û**

### 3Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´):**
- `—É—Å–ø–µ—à–Ω–æ` ‚ú®
- `–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ` ‚ú®
- `–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ` ‚ú®
- `—Å–±–ø` / `—Å–ø–±` ‚ú®

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:**
- `–ø–µ—Ä–µ–≤–æ–¥`, `–ø–ª–∞—Ç–µ–∂`, `payment`, `transfer`
- `—Å—É–º–º–∞`, `amount`, `–∏—Ç–æ–≥–æ`, `total`
- `—Å—Ç–∞—Ç—É—Å`, `status`, `–∫–≤–∏—Ç–∞–Ω—Ü–∏—è`, `receipt`

### 4Ô∏è‚É£ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

–ö–∞–∂–¥—ã–π –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é:

```
üì∏ Analyzing payment screenshot (800x600px) for amount 500 RUB
‚úÖ OCR successful (rus+eng): 2450 characters
üìÑ Recognized text (first 300 chars): —É—Å–ø–µ—à–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ —Å–±–ø –Ω–∞ —Å—É–º–º—É 500 —Ä—É–±–ª–µ–π...
‚úÖ CRITICAL PAYMENT INDICATOR FOUND
üí∞ Total amounts found: 3: [500.0, 15.0, 2024.0]
üîç Unique amounts (priority): [500.0, 2024.0, 15.0]
  Check 500.0 RUB vs 500 RUB: diff 0.00 (0.0%)
‚úÖ AMOUNT MATCHES: 500.0 RUB (expected 500)
üì± Looking for phone: +79999999999 (normalized: 79999999999)
üì± Found 1 phone numbers
‚úÖ PHONE MATCHES: +79999999999
‚úîÔ∏è VALIDATION RESULTS:
  1. Amount found: True (500.0 vs 500)
  2. Critical keywords: True
  3. ‚úÖ –Ω–æ–º–µ—Ä —Å–æ–≤–ø–∞–¥–∞–µ—Ç (9999999)
‚úÖ VALIDATION SUCCESS: all checks passed
üìã FINAL RESULT: valid=True, amount=500.0, phone=True
```

---

## üéØ –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (STRICT —Ä–µ–∂–∏–º)

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï —É—Å–ª–æ–≤–∏—è –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:

| –£—Å–ª–æ–≤–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ? | –ï—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ |
|---------|-------------|-------------------|
| –°—É–º–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (¬±5%) | ‚úÖ –î–ê | ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—É—Å–ø–µ—à–Ω–æ/–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ) | ‚ö†Ô∏è –ò–õ–ò | –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç |
| –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç | ‚ö†Ô∏è –ò–õ–ò | –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç |

### –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—à–µ–Ω–∏–π:

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  MATRIX OF VALIDATION DECISIONS             ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Amount Found (¬±5%) ‚ïë Critical KW's ‚ïë Phone Match  ‚ïë Result  ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë ‚úÖ Yes            ‚ïë ‚úÖ Yes        ‚ïë ‚úÖ Yes       ‚ïë ‚úÖ PASS ‚ïë
‚ïë ‚úÖ Yes            ‚ïë ‚úÖ Yes        ‚ïë ‚ùå No        ‚ïë ‚úÖ PASS ‚ïë
‚ïë ‚úÖ Yes            ‚ïë ‚ùå No         ‚ïë ‚úÖ Yes       ‚ïë ‚úÖ PASS ‚ïë
‚ïë ‚úÖ Yes (Perfect)  ‚ïë ‚ùå No         ‚ïë ‚ùå No        ‚ïë ‚úÖ PASS ‚ïë
‚ïë ‚úÖ Yes (Not Perf.)‚ïë ‚ùå No         ‚ïë ‚ùå No        ‚ïë ‚ùå FAIL ‚ïë
‚ïë ‚ùå No             ‚ïë ‚úÖ Yes        ‚ïë ‚úÖ Yes       ‚ïë ‚ùå FAIL ‚ïë
‚ïë ‚ùå No             ‚ïë ‚úÖ Yes        ‚ïë ‚ùå No        ‚ïë ‚ùå FAIL ‚ïë
‚ïë ‚ùå No             ‚ïë ‚ùå No         ‚ïë Any          ‚ïë ‚ùå FAIL ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

## üì≤ User Flow

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: ‚úÖ –£–°–ü–ï–®–ù–´–ô –ü–õ–ê–¢–ï–ñ

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"
2. –£–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É–º–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500 RUB)
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–ª–∞—Ç–µ–∂–∞
4. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–ª–∞—Ç–µ–∂–∞ –°–ë–ü..."
   ‚Üì
5. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç:
   ‚Ä¢ –°—É–º–º–∞: 500 RUB ‚úÖ
   ‚Ä¢ –°—Ç–∞—Ç—É—Å: "—É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ" ‚úÖ
   ‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚úÖ
   ‚Üì
6. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:
   ‚úÖ –°—É–º–º–∞: 500 RUB
   ‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
   ‚úÖ –°—Ç–∞—Ç—É—Å: –ø–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω (—É—Å–ø–µ—à–Ω–æ/–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ)
   ‚Üì
7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
8. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:
   ‚úÖ –û–ü–õ–ê–¢–ê –ü–û–õ–£–ß–ï–ù–ê –ò –ü–†–û–í–ï–†–ï–ù–ê!
   üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 1500 RUB
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–£–ú–ú–ê

```
1-3. [—Ç–æ –∂–µ —Å–∞–º–æ–µ]
4. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç:
   ‚Ä¢ –°—É–º–º–∞: 200 RUB ‚ùå (–æ–∂–∏–¥–∞–ª–æ—Å—å 500, —Ä–∞–∑–Ω–∏—Ü–∞ > 10%)
   ‚Ä¢ –°—Ç–∞—Ç—É—Å: "—É—Å–ø–µ—à–Ω–æ" ‚úÖ
   ‚Üì
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É:
   ‚ùå –ü–õ–ê–¢–ï–ñ –ù–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù
   ‚ùå –°—É–º–º–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ (–æ–∂–∏–¥–∞–ª–æ—Å—å 500 RUB)
   ‚úÖ –°—Ç–∞—Ç—É—Å: –ø–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
   ‚Üì
6. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:
   ‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç
   ‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω—É (@ferixdiii)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: ‚ùå –û–¢–°–£–¢–°–¢–í–£–Æ–¢ –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê

```
1-3. [—Ç–æ –∂–µ —Å–∞–º–æ–µ]
4. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç:
   ‚Ä¢ –°—É–º–º–∞: 500 RUB ‚úÖ
   ‚Ä¢ –°—Ç–∞—Ç—É—Å: –Ω–µ –Ω–∞–π–¥–µ–Ω ‚ùå
   ‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ‚ùå
   ‚Üì
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É:
   ‚ùå –ü–õ–ê–¢–ï–ñ –ù–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù
   ‚úÖ –°—É–º–º–∞: 500 RUB
   ‚ùå –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
   ‚ùå –°—Ç–∞—Ç—É—Å: –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
   ‚Üì
6. –¢—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê OCR

```
1-3. [—Ç–æ –∂–µ —Å–∞–º–æ–µ]
4. OCR –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π:
   ‚Üí analyze_payment_screenshot() –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
   ‚Üì
5. –°–∏—Å—Ç–µ–º–∞:
   ‚Ä¢ –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
   ‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç valid=False (STRICT: –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ–ø—É—Å–∫!)
   ‚Üì
6. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: [–¥–µ—Ç–∞–ª–∏]
   –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
   ‚ùå –ë–∞–ª–∞–Ω—Å –ù–ï –Ω–∞—á–∏—Å–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–Ω—Ç–∞–∫—Ç–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω–∞
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
PAYMENT_PHONE=+79999999999

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–µ–¥–µ–ª—å–Ω—ã–π –¥–æ–ø—É—Å–∫ –ø—Ä–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏
# (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5% –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏, 10% –¥–ª—è relax —Ä–µ–∂–∏–º–∞)
# PAYMENT_AMOUNT_TOLERANCE_PERCENT=5
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∫—Ä–∏–Ω—à–æ—Ç—É

–°–∫—Ä–∏–Ω—à–æ—Ç –¥–æ–ª–∂–µ–Ω —á–µ—Ç–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

| –≠–ª–µ–º–µ–Ω—Ç | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ? | –ü—Ä–∏–º–µ—Ä |
|---------|-------------|--------|
| **–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞** | ‚úÖ –î–ê | `500 ‚ÇΩ`, `–°—É–º–º–∞: 500` |
| **–ù–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è** | ‚ö†Ô∏è –ï–°–õ–ò `PAYMENT_PHONE` –∑–∞–¥–∞–Ω | `+7 (999) 999-99-99` |
| **–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞** | ‚úÖ –î–ê | `‚úì –£—Å–ø–µ—à–Ω–æ`, `–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ`, `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ` |
| **–í—Ä–µ–º—è/–¥–∞—Ç–∞** | ‚ö†Ô∏è –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | `14:35` –∏–ª–∏ `2024-01-15` |
| **–õ–æ–≥–æ—Ç–∏–ø –±–∞–Ω–∫–∞/–°–ë–ü** | ‚ö†Ô∏è –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | –Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞, –°–±–µ—Ä–±–∞–Ω–∫, –∏ —Ç.–¥. |

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –£–°–ü–ï–®–ù–´–ô –ê–ù–ê–õ–ò–ó

```
üì∏ Analyzing payment screenshot (1125x2436px) for amount 500 RUB
‚úÖ OCR successful (rus+eng): 1847 characters
‚úÖ CRITICAL PAYMENT INDICATOR FOUND
üí∞ Total amounts found: 2: [500.0, 2024.0]
Check 500.0 RUB vs 500 RUB: diff 0.00 (0.0%)
‚úÖ AMOUNT MATCHES: 500.0 RUB (expected 500)
üì± Looking for phone: +79999999999 (normalized: 79999999999)
üì± Found 1 phone numbers
‚úÖ PHONE MATCHES: +79999999999
‚úîÔ∏è VALIDATION RESULTS:
  1. Amount found: True (500.0 vs 500)
  2. Critical keywords: True
  3. ‚úÖ –Ω–æ–º–µ—Ä —Å–æ–≤–ø–∞–¥–∞–µ—Ç
‚úÖ VALIDATION SUCCESS: all checks passed
‚úÖ Balance credited: user=123456789, added=500 RUB, new_balance=1500 RUB
```

### ‚ùå –û–®–ò–ë–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò

```
üì∏ Analyzing payment screenshot (800x600px) for amount 500 RUB
‚úÖ OCR successful (rus+eng): 924 characters
‚ö†Ô∏è NO payment indicators found
üí∞ Total amounts found: 1: [200.0]
Check 200.0 RUB vs 500 RUB: diff 300.00 (60.0%)
‚ùå AMOUNT DOESN'T MATCH: closest found 200.0 RUB (expected 500)
üì± Looking for phone: +79999999999 (normalized: 79999999999)
‚ùå PHONE NOT FOUND in screenshot
‚ö†Ô∏è WARNING: amount found but no supporting indicators
‚ùå VALIDATION REJECTED: amount not found or doesn't match
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

| –ê—Ç–∞–∫–∞ | –ó–∞—â–∏—Ç–∞ |
|-------|--------|
| –°–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ `screenshot_file_id` (–¥—É–±–ª–∏–∫–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è) |
| –ü–æ–¥–¥–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º —Å —Å–∏–º–≤–æ–ª–æ–º ‚ÇΩ |
| –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Ü–∏—Ñ—Ä |
| –ü—É—Å—Ç–æ–π —Å–∫—Ä–∏–Ω—à–æ—Ç | OCR –Ω–µ –Ω–∞–π–¥–µ—Ç —Ç–µ–∫—Å—Ç ‚Üí –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ |
| –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç | –¢—Ä–µ–±—É–µ—Ç –≤—Å–µ —Ç—Ä–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞ (—Å—É–º–º–∞ + —Å—Ç–∞—Ç—É—Å + –Ω–æ–º–µ—Ä) |
| –û—à–∏–±–∫–∞ OCR | **FAIL CLOSED**: –û—Ç–∫–ª–æ–Ω–µ–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞

–ö–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:
```python
logger.info(f"‚úÖ Balance credited: user={user_id}, added={amount} RUB, new_balance={new_balance} RUB")
logger.warning(f"‚ùå VALIDATION REJECTED: amount not found or doesn't match")
logger.error(f"‚ùå OCR API ERROR in analyze_payment_screenshot: {e}", exc_info=True)
```

---

## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥

### –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π

```python
# bot_kie.py, —Å—Ç—Ä–æ–∫–∏ 14650-14850

# 1. –ü–æ–ª—É—á–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
photo = update.message.photo[-1]
image_data = await file.download_as_bytearray()

# 2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é OCR
analysis = await analyze_payment_screenshot(
    image_data,
    expected_amount=500,
    expected_phone="+79999999999"
)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (STRICT: default False)
if not analysis.get('valid', False):
    # ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
    await message.reply_text(analysis['message'])
else:
    # ‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å
    await add_payment_async(user_id, amount, screenshot_file_id)
    await message.reply_text("‚úÖ –ë–∞–ª–∞–Ω—Å –Ω–∞—á–∏—Å–ª–µ–Ω!")
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è

### –ß—Ç–æ –±—ã–ª–æ —É–ª—É—á—à–µ–Ω–æ –≤ v2.0

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|----|----- |
| **–î–æ–ø—É—Å–∫ —Å—É–º–º—ã** | ¬±10% + 10 RUB | ¬±5% (STRICT) |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞** | –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ | Regex + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è |
| **–û—à–∏–±–∫–∞ OCR** | Auto-credit (–æ–ø–∞—Å–Ω–æ!) | FAIL CLOSED (–±–µ–∑–æ–ø–∞—Å–Ω–æ!) |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë–∞–∑–æ–≤–æ–µ | –ü–æ–ª–Ω–æ–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ |
| **–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞** | 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ | 20+ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ + –¥–æ–ø.) |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤** | eng | rus+eng+fallback |

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ö–∞–∫ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂

```python
# –í Python —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
import asyncio
from bot_kie import analyze_payment_screenshot

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
with open('screenshot.png', 'rb') as f:
    image_data = f.read()

# –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
result = asyncio.run(analyze_payment_screenshot(
    image_data,
    expected_amount=500,
    expected_phone="+79999999999"
))

# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
print(f"Valid: {result['valid']}")
print(f"Amount: {result['found_amount']}")
print(f"Phone: {result['phone_found']}")
print(f"Message:\n{result['message']}")
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

```python
# –í–∫–ª—é—á–∏—Ç—å DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ bot_kie.py
import logging
logging.getLogger().setLevel(logging.DEBUG)

# –¢–µ–ø–µ—Ä—å –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å—É–º–º—ã, –Ω–æ–º–µ—Ä–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–µ–π:** @ferixdiii  
**–ü—Ä–æ–±–ª–µ–º—ã —Å OCR:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ `app.log`  
**–†—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ:** `/admin users` ‚Üí –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤—Ä—É—á–Ω—É—é

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Pillow: `pip install Pillow`
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pytesseract: `pip install pytesseract`
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tesseract-ocr –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] –ó–∞–¥–∞—Ç—å `PAYMENT_PHONE` –≤ .env
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ WEBHOOK –∏–ª–∏ POLLING —Ä–µ–∂–∏–º–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ `app.log` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ OCR
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–í–µ—Ä—Å–∏—è:** 2.0 (STRICT MODE)  
**–î–∞—Ç–∞:** 2024-01-15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
