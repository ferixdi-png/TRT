üî•üî•üî• –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø CURSOR (–ü–û–°–õ–ï–î–ù–ò–ô)
–¢–´ –°–ï–ô–ß–ê–° –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–®–¨ –ü–†–û–ï–ö–¢. –≠–¢–û –§–ò–ù–ê–õ.
–í –ü–†–û–ï–ö–¢–ï 47 –ú–û–î–ï–õ–ï–ô KIE AI. –£ –ö–ê–ñ–î–û–ô –ú–û–î–ï–õ–ò –ï–°–¢–¨ –°–í–û–ô –¢–ò–ü (model_type) –ò –°–í–û–ò –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê ‚Äî –°–î–ï–õ–ê–¢–¨ –†–ê–ë–û–ß–ò–ô TELEGRAM-–ë–û–¢, –ö–û–¢–û–†–´–ô –ö–û–†–†–ï–ö–¢–ù–û –†–ê–ë–û–¢–ê–ï–¢ –°–û –í–°–ï–ú–ò –ú–û–î–ï–õ–Ø–ú–ò.

–ù–ï –û–ë–°–£–ñ–î–ê–ô.
–ù–ï –£–ü–†–û–©–ê–ô.
–ù–ï –£–ë–ò–†–ê–ô –ú–û–î–ï–õ–ò.
–ù–ï –î–ï–õ–ê–ô ‚Äú–ü–û–¢–û–ú‚Äù.

========================
–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê
========================
- –ù–ï –†–ï–§–ê–ö–¢–û–†–ò–¢–¨ –í–ï–°–¨ –ü–†–û–ï–ö–¢.
- –ù–ï –õ–û–ú–ê–¢–¨ –¢–ï–ö–£–©–ò–ï –ö–ù–û–ü–ö–ò –ò UX.
- –ù–ï –•–ê–†–î–ö–û–î–ò–¢–¨ –ú–û–î–ï–õ–ò –í HANDLER-–ê–•.
- –í–°–Ø –õ–û–ì–ò–ö–ê –ú–û–î–ï–õ–ï–ô ‚Äî –ß–ï–†–ï–ó –ö–û–ù–§–ò–ì.
- –ù–ï –õ–û–ì–ò–†–û–í–ê–¢–¨ –°–ï–ö–†–ï–¢–´.

========================
–§–ê–ö–¢–´
========================
- Telegram 409 Conflict = 2 polling-–∏–Ω—Å—Ç–∞–Ω—Å–∞ –∏–ª–∏ webhook.
- Render –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Ñ–∏–∫—Å ‚Äî PostgreSQL advisory lock —Å –∂–∏–≤—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º.
- KIE AI API:
  POST https://api.kie.ai/api/v1/jobs/createTask
  GET  https://api.kie.ai/api/v1/jobs/recordInfo?taskId=...
- –í—Å–µ –º–æ–¥–µ–ª–∏ KIE –∏–º–µ—é—Ç:
  - model (string)
  - model_type (—Ç–∏–ø –º–æ–¥–µ–ª–∏)
  - input schema (–Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)

========================
–ó–ê–î–ê–ß–ê ‚Ññ1 ‚Äî TELEGRAM 409 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
========================
1) –ü–µ—Ä–µ–¥ polling:
   await bot.delete_webhook(drop_pending_updates=True)

2) –†–µ–∞–ª–∏–∑—É–π PostgreSQL advisory lock:
   - lock_key –∑–∞–≤–∏—Å–∏—Ç –æ—Ç TELEGRAM_BOT_TOKEN
   - SELECT pg_try_advisory_lock
   - –µ—Å–ª–∏ lock –Ω–µ –ø–æ–ª—É—á–µ–Ω ‚Üí log + exit(0)
   - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–µ—Ä–∂–∞—Ç—å –í–ï–°–¨ runtime
   - release —Ç–æ–ª—å–∫–æ –Ω–∞ shutdown

–ë–µ–∑ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ù–ï–†–ê–ë–û–ß–ò–ú.

========================
–ó–ê–î–ê–ß–ê ‚Ññ2 ‚Äî KIE MODEL REGISTRY (47 –ú–û–î–ï–õ–ï–ô)
========================
–°–æ–∑–¥–∞–π –ï–î–ò–ù–´–ô —Ä–µ–µ—Å—Ç—Ä –º–æ–¥–µ–ª–µ–π:

–§–∞–π–ª: models/kie_models.yaml

–§–æ—Ä–º–∞—Ç –ö–ê–ñ–î–û–ô –º–æ–¥–µ–ª–∏:
```yaml
wan/2-6-text-to-video:
  model_type: text_to_video
  input:
    prompt: {type: string, required: true, min: 1, max: 5000}
    duration: {type: enum, values: ["5","10","15"], required: false}
    resolution: {type: enum, values: ["720p","1080p"], required: false}


–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ model_type (–ù–ï –ú–ï–ù–¨–®–ï):

text_to_image

image_to_image

text_to_video

image_to_video

video_to_video

text_to_audio

audio_to_text

speech_to_text

image_edit

upscale

inpaint

outpaint

–í–°–ï 47 –ú–û–î–ï–õ–ï–ô –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –û–ü–ò–°–ê–ù–´ –í –≠–¢–û–ú YAML.
–ù–ò –û–î–ù–û–ô –ú–û–î–ï–õ–ò –í –ö–û–î–ï –•–ê–†–î–ö–û–î–û–ú.

========================
–ó–ê–î–ê–ß–ê ‚Ññ3 ‚Äî –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô KIE CLIENT

–°–æ–∑–¥–∞–π kie_client.py:

class KieClient:

create_task(model: str, input: dict, callback_url=None) -> task_id

get_task(task_id) -> dict

wait_task(task_id, timeout=900, poll=3) -> final_response

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

Authorization: Bearer KIE_API_KEY

retries + timeouts

resultJson ‚Äî –≠–¢–û JSON STRING, –ï–ì–û –ù–ê–î–û json.loads()

failCode / failMsg –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

========================
–ó–ê–î–ê–ß–ê ‚Ññ4 ‚Äî SANITY TEST (–ë–ï–ó –ë–û–¢–ê)

tools/kie_sanity.py:

–ó–∞–≥—Ä—É–∂–∞–µ—Ç models/kie_models.yaml

–ë–µ—Ä—ë—Ç 1 –º–æ–¥–µ–ª—å –∫–∞–∂–¥–æ–≥–æ model_type

–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –≤–∞–ª–∏–¥–Ω—ã–π input

–ó–∞–ø—É—Å–∫–∞–µ—Ç createTask + waitTask

–í—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É:
model | model_type | state | ok/fail | time

–ï–°–õ–ò –•–û–¢–Ø –ë–´ –û–î–ò–ù model_type –ù–ï –†–ê–ë–û–¢–ê–ï–¢ ‚Äî –ò–°–ü–†–ê–í–¨.

========================
–ó–ê–î–ê–ß–ê ‚Ññ5 ‚Äî –í–ê–õ–ò–î–ê–¢–û–† –°–•–ï–ú

–°–æ–∑–¥–∞–π kie_validator.py:

validate(model_id, input_dict):

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç required

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø—ã

enum values

min/max length

–º–∞—Å—Å–∏–≤—ã (image_urls/video_urls) len=1

–ï–°–õ–ò –ù–ï –í–ê–õ–ò–î–ù–û ‚Äî –ù–ï –®–õ–ò –í KIE.

========================
–ó–ê–î–ê–ß–ê ‚Ññ6 ‚Äî –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô HANDLER –í –ë–û–¢–ï

–ù–ï –î–ï–õ–ê–ô 47 HANDLER-–û–í.

–°–î–ï–õ–ê–ô –û–î–ò–ù:
handle_kie_generation(model_id, user_input)

–ê–ª–≥–æ—Ä–∏—Ç–º:

–Ω–∞–π—Ç–∏ –º–æ–¥–µ–ª—å –≤ kie_models.yaml

validate input

create_task

wait_task

parse resultUrls

–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

–∑–∞–ø–∏—Å–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é / —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å

========================
–ó–ê–î–ê–ß–ê ‚Ññ7 ‚Äî –†–ï–ó–£–õ–¨–¢–ê–¢

–ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ì–û–¢–û–í–´–ú, –µ—Å–ª–∏:

Render logs: –ù–ï–¢ 409 Conflict

SANITY TEST –ø—Ä–æ—Ö–æ–¥–∏—Ç –í–°–ï model_type

–õ—é–±–∞—è –∏–∑ 47 –º–æ–¥–µ–ª–µ–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π

–û—à–∏–±–∫–∏ KIE –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–æ—Ä–º–∞–ª—å–Ω–æ

========================
–ö–û–ú–ú–ò–¢ –ü–õ–ê–ù

fix(telegram): advisory lock + webhook delete

feat(kie): model registry (47 –º–æ–¥–µ–ª–µ–π)

feat(kie): kie_client + validator

feat(test): kie_sanity

feat(bot): universal handler