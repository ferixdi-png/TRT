# UX_FINAL.md ‚Äî Final Premium AI Studio Architecture

## üéØ Overview

–ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–µ–º–∏—É–º AI Studio –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è, wizard –¥–ª—è –≤–≤–æ–¥–∞, —à–∞–±–ª–æ–Ω—ã –∏ –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å UI.

---

## ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ Fixes (–í–´–ü–û–õ–ù–ï–ù–û)

### 1. DatabaseService.fetchrow
- **–ü—Ä–æ–±–ª–µ–º–∞**: `'DatabaseService' object has no attribute 'fetchrow'`
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `fetchrow()` –∏ –∞–ª–∏–∞—Å `fetchone()` –≤ [app/database/services.py](app/database/services.py)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 2. FK violation: generation_events.user_id
- **–ü—Ä–æ–±–ª–µ–º–∞**: `Key (user_id) is not present in table "users"`
- **–†–µ—à–µ–Ω–∏–µ**: `log_generation_event()` —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `UserService.get_or_create()` –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Best-effort —Ä–µ–∂–∏–º ‚Äî –Ω–µ —Ä–æ–Ω—è–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–§–∞–π–ª**: [app/database/generation_events.py](app/database/generation_events.py)

### 3. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (t.me/bot)
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°—Å—ã–ª–∫–∞ –≤–µ–ª–∞ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π @bot
- **–†–µ—à–µ–Ω–∏–µ**:
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `telegram_bot_username` –≤ –∫–æ–Ω—Ñ–∏–≥ (ENV: `TELEGRAM_BOT_USERNAME` –∏–ª–∏ `BOT_USERNAME`)
  - –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å [bot/utils/bot_info.py](bot/utils/bot_info.py) —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º username —á–µ—Ä–µ–∑ `bot.get_me()`
  - –û–±–Ω–æ–≤–ª—ë–Ω [bot/handlers/marketing.py](bot/handlers/marketing.py) ‚Äî —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π username
  - Graceful fallback: –µ—Å–ª–∏ username –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –±–∏—Ç–æ–π —Å—Å—ã–ª–∫–∏
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 4. API –æ—à–∏–±–∫–∞ "This field is required"
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API, –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–†–µ—à–µ–Ω–∏–µ**:
  - –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ **InputSpec** ([app/ui/input_spec.py](app/ui/input_spec.py)) ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
  - Wizard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç required –ø–æ–ª—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
  - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API –≤ wizard ([bot/flows/wizard.py](bot/flows/wizard.py))
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å/–ú–µ–Ω—é"
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üé® –ù–æ–≤—ã–π UX (Premium AI Studio)

### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
**–§–∞–π–ª**: [bot/handlers/marketing.py](bot/handlers/marketing.py)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
üß© –§–æ—Ä–º–∞—Ç—ã                  ‚Üê –ì–õ–ê–í–ù–´–ô –í–•–û–î
üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ | üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ (5)
üé® –ö–∞—Ä—Ç–∏–Ω–∫–∏ | üé¨ –í–∏–¥–µ–æ
‚úçÔ∏è –¢–µ–∫—Å—Ç—ã | üéô –ê—É–¥–∏–æ
ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–∫–∞ (–±–æ–Ω—É—Å—ã)
üìú –ò—Å—Ç–æ—Ä–∏—è | üí≥ –ë–∞–ª–∞–Ω—Å
üíé –¢–∞—Ä–∏—Ñ—ã | üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞
```

### –§–æ—Ä–º–∞—Ç—ã (Format-Based Navigation)
**–§–∞–π–ª**: [app/ui/formats.py](app/ui/formats.py), [bot/handlers/formats.py](bot/handlers/formats.py)

6 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
1. ‚úçÔ∏è **Text ‚Üí Image** (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ —Ç–µ–∫—Å—Ç–∞)
2. üñº **Image ‚Üí Image** (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
3. üñº **Image ‚Üí Video** (–ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ —Ñ–æ—Ç–æ –≤ –≤–∏–¥–µ–æ)
4. üé¨ **Text ‚Üí Video** (—Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞)
5. üéô **Text ‚Üí Audio** (–æ–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞)
6. üéö **Audio ‚Üí Audio** (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ)

**–ö–∞–∂–¥—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç**:
- ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º (3 –º–æ–¥–µ–ª–∏)
- üî• –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ (5-8 –º–æ–¥–µ–ª–µ–π)
- üìö –í—Å–µ –º–æ–¥–µ–ª–∏ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)

### –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
**–§–∞–π–ª**: [app/ui/curated_popular.json](app/ui/curated_popular.json)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã**:
1. **DB-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** (–µ—Å–ª–∏ –µ—Å—Ç—å generation_events)
2. **Curated list** –∏–∑ `curated_popular.json`
3. **Heuristic**: free tier > –¥–µ—à—ë–≤—ã–µ > –∞–ª—Ñ–∞–≤–∏—Ç

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: recommended ‚Üí popular ‚Üí price ‚Üí name

### –ö–∞—Ä—Ç–æ—á–∫–∞ –º–æ–¥–µ–ª–∏
**–§–∞–π–ª**: [app/ui/render.py](app/ui/render.py)

**–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ–∑–¥–µ**:
```
üé® –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏

–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –¥–µ–ª–∞–µ—Ç

–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
‚Ä¢ –ë–∞–Ω–Ω–µ—Ä—ã –¥–ª—è —Ä–µ–∫–ª–∞–º—ã
‚Ä¢ –û–±–ª–æ–∂–∫–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤
‚Ä¢ –ö—Ä–µ–∞—Ç–∏–≤—ã –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∞

–í—Ö–æ–¥: ‚úçÔ∏è —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–í—ã—Ö–æ–¥: üñº –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

üí∞ –¶–µ–Ω–∞: 10.50 ‚ÇΩ  (–∏–ª–∏ üÜì –ë–ï–°–ü–õ–ê–¢–ù–û)

–°–æ–≤–µ—Ç: –û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å

[üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å] [üß™ –®–∞–±–ª–æ–Ω—ã]
[üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ] [‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ]
[‚óÄÔ∏è –ù–∞–∑–∞–¥] [üè† –ú–µ–Ω—é]
[üí≥ –ë–∞–ª–∞–Ω—Å] [üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞]
```

---

## üßô Wizard (–£–º–Ω—ã–π –º–∞—Å—Ç–µ—Ä –≤–≤–æ–¥–∞)

**–§–∞–π–ª**: [bot/flows/wizard.py](bot/flows/wizard.py)

### –°–∏—Å—Ç–µ–º–∞ InputSpec
**–§–∞–π–ª**: [app/ui/input_spec.py](app/ui/input_spec.py)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã**:
- `text` ‚Äî —Ç–µ–∫—Å—Ç
- `image_url` / `image_file` ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- `video_url` / `video_file` ‚Äî –≤–∏–¥–µ–æ
- `audio_url` / `audio_file` ‚Äî –∞—É–¥–∏–æ
- `enum` ‚Äî –≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
- `number` ‚Äî —á–∏—Å–ª–æ (—Å min/max)
- `boolean` ‚Äî –¥–∞/–Ω–µ—Ç

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ InputSpec** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
1. `input_schema` –∏–∑ KIE_SOURCE_OF_TRUTH
2. –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ category/output_type

### Wizard Flow

**–®–∞–≥–∏**:
1. **–ü–æ–∫–∞–∑ –ø–æ–ª—è** ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–º–µ—Ä, –ø–æ–¥—Å–∫–∞–∑–∫–∏
2. **–í–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è** ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
3. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** ‚Äî summary + —Ü–µ–Ω–∞
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å payments/kie

**–ö–Ω–æ–ø–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ**:
- ‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–¥–ª—è optional)
- ‚ú® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚óÄÔ∏è –ù–∞–∑–∞–¥
- üè† –í –º–µ–Ω—é

**–§–∏–Ω–∞–ª**:
```
‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞

üéØ –ú–æ–¥–µ–ª—å: Sora 2 Text To Video

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
‚Ä¢ prompt: –∫—Ä–∞—Å–∏–≤—ã–π –∑–∞–∫–∞—Ç
‚Ä¢ duration: 10

üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 598.00 ‚ÇΩ

üöÄ –í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!

[‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å] [‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å] [üè† –í –º–µ–Ω—é]
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç –ø—É—Å—Ç—ã–µ required)
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- Graceful fallback –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö
- –ö–Ω–æ–ø–∫–∏ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å / –í –º–µ–Ω—é / –ü–æ–¥–¥–µ—Ä–∂–∫–∞"

---

## üß™ –®–∞–±–ª–æ–Ω—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤

**–§–∞–π–ª**: [app/ui/templates.py](app/ui/templates.py)

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤

**Text ‚Üí Image**:
- üéØ –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä
- üì± –ü–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π
- üìñ –û–±–ª–æ–∂–∫–∞ –¥–ª—è Stories

**Text ‚Üí Video**:
- üì± Reels –¥–ª—è Instagram
- üé¨ YouTube Short

**Image ‚Üí Video**:
- üõç –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞
- üìπ UGC-–≤–∏–¥–µ–æ

**Text ‚Üí Audio**:
- üéô –û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω
2. –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ 2-4 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç
4. –°—Ä–∞–∑—É –≥–æ—Ç–æ–≤ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä**:
```
–®–∞–±–ª–æ–Ω: –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä

–í–æ–ø—Ä–æ—Å—ã:
1. –ß—Ç–æ —Ä–µ–∫–ª–∞–º–∏—Ä—É–µ–º? ‚Üí "–Ω–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –æ–¥–µ–∂–¥—ã"
2. –°—Ç–∏–ª—å? ‚Üí "–º–∏–Ω–∏–º–∞–ª–∏–∑–º"
3. –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞? ‚Üí "—Å–∏–Ω–∏–π –∏ –±–µ–ª—ã–π"

‚Üí –ü—Ä–æ–º–ø—Ç: "–†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –Ω–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –æ–¥–µ–∂–¥—ã,
            –º–∏–Ω–∏–º–∞–ª–∏–∑–º —Å—Ç–∏–ª—å, —Å–∏–Ω–∏–π –∏ –±–µ–ª—ã–π —Ü–≤–µ—Ç–∞,
            –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω"
```

---

## üóÇ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏

```
app/ui/
‚îú‚îÄ‚îÄ input_spec.py         ‚Üê InputSpec —Å–∏—Å—Ç–µ–º–∞ (—Ç–∏–ø—ã –ø–æ–ª–µ–π, –≤–∞–ª–∏–¥–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ formats.py            ‚Üê Format-based –Ω–∞–≤–∏–≥–∞—Ü–∏—è (6 —Ñ–æ—Ä–º–∞—Ç–æ–≤)
‚îú‚îÄ‚îÄ render.py             ‚Üê –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å UI (–≤—Å–µ —ç–∫—Ä–∞–Ω—ã)
‚îú‚îÄ‚îÄ templates.py          ‚Üê –®–∞–±–ª–æ–Ω—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤
‚îî‚îÄ‚îÄ curated_popular.json  ‚Üê Curated popularity + recommendations

bot/flows/
‚îî‚îÄ‚îÄ wizard.py             ‚Üê Wizard flow (–ø–æ—à–∞–≥–æ–≤—ã–π –≤–≤–æ–¥)

bot/handlers/
‚îî‚îÄ‚îÄ formats.py            ‚Üê Format navigation handlers

bot/utils/
‚îî‚îÄ‚îÄ bot_info.py           ‚Üê Bot username caching + referral links
```

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

```
app/database/
‚îú‚îÄ‚îÄ services.py           ‚Üê +fetchrow/fetchone
‚îî‚îÄ‚îÄ generation_events.py  ‚Üê +FK protection

app/utils/
‚îî‚îÄ‚îÄ config.py             ‚Üê +telegram_bot_username

bot/handlers/
‚îî‚îÄ‚îÄ marketing.py          ‚Üê –û–±–Ω–æ–≤–ª–µ–Ω–æ –º–µ–Ω—é, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞

main_render.py            ‚Üê –ü–æ–¥–∫–ª—é—á–µ–Ω—ã formats_router, wizard_router
```

---

## üß™ –¢–µ—Å—Ç—ã –∏ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### Verify Script
**–§–∞–π–ª**: [scripts/verify_fixpack.py](scripts/verify_fixpack.py)

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
1. ‚úÖ DatabaseService.fetchrow exists
2. ‚úÖ FK violation protection
3. ‚úÖ Referral link uses real username
4. ‚úÖ All models have InputSpec
5. ‚úÖ Wizard validates required fields
6. ‚úÖ Format system works
7. ‚úÖ UI render functions work
8. ‚úÖ Templates work
9. ‚úÖ No hardcoded secrets

**–ó–∞–ø—É—Å–∫**:
```bash
python scripts/verify_fixpack.py
```

### Unit Tests (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ)

```python
# tests/test_input_spec.py
def test_required_field_validation():
    field = InputField(name="test", type=InputType.TEXT, required=True, description="Test")
    assert not field.validate(None)[0]  # Should fail
    assert field.validate("value")[0]   # Should pass

# tests/test_formats.py
def test_format_detection():
    model = {"category": "text-to-image"}
    format_obj = get_model_format(model)
    assert format_obj.key == "text-to-image"

# tests/test_referral.py
def test_referral_link():
    link = get_referral_link("mybot", 12345)
    assert link == "https://t.me/mybot?start=ref_12345"
```

---

## üìã Checklist –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ë–∞–∑–æ–≤—ã–π —Ñ–ª–æ—É (‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```
/start
‚Üí üß© –§–æ—Ä–º–∞—Ç—ã
‚Üí ‚úçÔ∏è Text ‚Üí Image
‚Üí [–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å]
‚Üí Wizard (–≤–≤–æ–¥ prompt)
‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç
```

### 2. Image ‚Üí Video (‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```
üß© –§–æ—Ä–º–∞—Ç—ã
‚Üí üñº Image ‚Üí Video
‚Üí [–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å]
‚Üí Wizard:
   - –ó–∞–ø—Ä–æ—Å image_url
   - –ù–ï –¥–∞—ë—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç
‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### 3. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```
–ú–µ–Ω—é ‚Üí ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–∫–∞
‚Üí –°—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ (@username)
‚Üí –ù–ï "t.me/bot?start=..."
‚Üí –ö–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### 4. –®–∞–±–ª–æ–Ω—ã

```
[–õ—é–±–∞—è –º–æ–¥–µ–ª—å]
‚Üí üß™ –®–∞–±–ª–æ–Ω—ã
‚Üí [–í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω]
‚Üí –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Üí –ü—Ä–æ–º–ø—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```

### 5. –û—à–∏–±–∫–∏ –Ω–µ —Ä–æ–Ω—è—é—Ç UX

```
[–õ—é–±–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –æ—à–∏–±–∫–æ–π]
‚Üí –í–∏–¥–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
‚Üí –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∏:
   üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
   üè† –í –º–µ–Ω—é
   üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞
‚Üí –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–æ
```

---

## üöÄ –ó–∞–ø—É—Å–∫

### Development
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ENV
export TELEGRAM_BOT_TOKEN="your_token"
export TELEGRAM_BOT_USERNAME="your_bot_username"  # –ë–ï–ó @
export KIE_API_KEY="your_key"
export ADMIN_ID="123456789"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
python main_render.py
```

### Production (Render)
```bash
# ENV vars –≤ Render Dashboard:
TELEGRAM_BOT_TOKEN=...
TELEGRAM_BOT_USERNAME=...  # –ë–ï–ó @
KIE_API_KEY=...
ADMIN_ID=...
DATABASE_URL=...  # Postgres

# Deploy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏ push –≤ main
```

### Verify –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
```bash
python scripts/verify_fixpack.py
```

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ/—Å–æ–∑–¥–∞–Ω–Ω—ã–µ

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ
1. `app/ui/input_spec.py` ‚Äî —Å–∏—Å—Ç–µ–º–∞ InputSpec
2. `app/ui/formats.py` ‚Äî —Ñ–æ—Ä–º–∞—Ç—ã –∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
3. `app/ui/render.py` ‚Äî –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å UI
4. `app/ui/templates.py` ‚Äî —à–∞–±–ª–æ–Ω—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤
5. `app/ui/curated_popular.json` ‚Äî curated —Å–ø–∏—Å–æ–∫
6. `bot/flows/wizard.py` ‚Äî wizard flow
7. `bot/flows/__init__.py`
8. `bot/handlers/formats.py` ‚Äî format navigation
9. `bot/utils/bot_info.py` ‚Äî bot username + referral
10. `bot/utils/__init__.py`
11. `scripts/verify_fixpack.py` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
12. `UX_FINAL.md` ‚Äî —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ
1. `app/database/services.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω fetchrow/fetchone
2. `app/database/generation_events.py` ‚Äî FK protection
3. `app/utils/config.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ telegram_bot_username
4. `bot/handlers/marketing.py` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–æ –º–µ–Ω—é, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
5. `main_render.py` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω—ã formats_router, wizard_router

---

## üéâ –ò—Ç–æ–≥

### –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã ‚úÖ
- DatabaseService.fetchrow —Ä–∞–±–æ—Ç–∞–µ—Ç
- FK violation –±–æ–ª—å—à–µ –Ω–µ —Ä–æ–Ω—è–µ—Ç –±–æ—Ç–∞
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
- API –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç UX

### –ü—Ä–µ–º–∏—É–º UX –ø–æ—Å—Ç—Ä–æ–µ–Ω ‚úÖ
- –§–æ—Ä–º–∞—Ç—ã –≤–º–µ—Å—Ç–æ —Ö–∞–æ—Ç–∏—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
- Wizard —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤
- –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–µ–∫
- –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ/–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚úÖ
- Best-effort –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Graceful fallback –≤–µ–∑–¥–µ
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ ‚úÖ
- –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (ui/, flows/, handlers/)
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (KIE_SOURCE_OF_TRUTH.json)
- Verify —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å—ë
- –ù–µ—Ç hardcoded —Å–µ–∫—Ä–µ—Ç–æ–≤

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É.** üöÄ
