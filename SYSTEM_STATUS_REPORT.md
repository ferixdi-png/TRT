# üìä –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –û –°–û–°–¢–û–Ø–ù–ò–ò –°–ò–°–¢–ï–ú–´

**–î–∞—Ç–∞:** 2025-12-25  
**–í–µ—Ä—Å–∏—è SOURCE_OF_TRUTH:** v1.2.6-ENDPOINT-FIX  
**–°—Ç–∞—Ç—É—Å:** üü° –†–ê–ë–û–¢–ê–ï–¢ –° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø–ú–ò

---

## üìã EXECUTIVE SUMMARY

–°–∏—Å—Ç–µ–º–∞ Kie.ai Telegram Bot –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **—Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏** —Å 72 –º–æ–¥–µ–ª—è–º–∏ –≤ SOURCE_OF_TRUTH. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ø–∞—Ä—Å–µ—Ä, builder, UI, pricing) –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **5 –ø—Ä–æ–±–ª–µ–º**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö **1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è** (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ config.json).

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|---------|----------|--------|
| –ú–æ–¥–µ–ª–µ–π –≤ SOT | 72 | ‚úÖ 100% |
| FREE –º–æ–¥–µ–ª–µ–π | 4 | ‚úÖ |
| –ú–æ–¥–µ–ª–µ–π —Å —Ü–µ–Ω–∞–º–∏ | 72/72 | ‚úÖ 100% |
| –ö–∞—Ç–µ–≥–æ—Ä–∏–π | 7 | ‚úÖ |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü | 158 HTML | ‚úÖ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º | 1 | üî¥ |
| –ü—Ä–æ–±–ª–µ–º –≤—ã—Å–æ–∫–æ–π –≤–∞–∂–Ω–æ—Å—Ç–∏ | 1 | üü† |

---

## üéØ 1. SOURCE OF TRUTH (–û—Å–Ω–æ–≤–∞ —Å–∏—Å—Ç–µ–º—ã)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –û–¢–õ–ò–ß–ù–û

**–§–∞–π–ª:** `models/KIE_SOURCE_OF_TRUTH.json`

```json
{
  "version": "1.2.6-ENDPOINT-FIX",
  "last_updated": "2025-12-25T04:10:00Z",
  "total_models": 72
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

#### –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (7 –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ú–æ–¥–µ–ª–µ–π | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|---------|---------|
| **image** | 31 | seedream, qwen/text-to-image, flux |
| **video** | 19 | wan, veo3_fast, kling |
| **other** | 8 | —Ä–∞–∑–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã |
| **enhance** | 6 | —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ |
| **audio** | 4 | TTS, audio processing |
| **avatar** | 2 | —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ |
| **music** | 2 | –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏ |

#### –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ

```
‚úÖ –° —Ü–µ–Ω–∞–º–∏ (rub_per_gen): 72/72 (100%)
‚úÖ FREE –º–æ–¥–µ–ª–∏ (0 RUB): 4
   ‚Ä¢ z-image
   ‚Ä¢ qwen/text-to-image
   ‚Ä¢ qwen/image-to-image
   ‚Ä¢ qwen/image-edit
```

#### Endpoints (2 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö)

| Endpoint | –ú–æ–¥–µ–ª–µ–π | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|----------|---------|------------|
| `/api/v1/jobs/createTask` | 71 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π endpoint |
| `/api/v1/veo/generate` | 1 | –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π (veo3_fast) |

### –ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

**‚úÖ –í–°–ï 72 –ú–û–î–ï–õ–ò –ò–ú–ï–Æ–¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–û–õ–Ø:**

- `model_id` - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `provider` - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–¥–µ–ª–∏
- `category` - –∫–∞—Ç–µ–≥–æ—Ä–∏—è (image/video/audio/etc)
- `display_name` - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
- `endpoint` - API endpoint
- `method` - HTTP –º–µ—Ç–æ–¥ (POST)
- `input_schema` - —Å—Ö–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- `pricing` - —Ü–µ–Ω—ã (rub_per_gen, usd_per_gen)

**–í—ã–≤–æ–¥:** SOURCE_OF_TRUTH –≤ –∏–¥–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏! üéâ

---

## üîß 2. PARSER SYSTEM (–ü–∞—Ä—Å–∏–Ω–≥ Copy pages)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –†–ê–ë–û–¢–ê–ï–¢

**–§–∞–π–ª:** `scripts/master_kie_parser.py`

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|---------|--------|------------|
| Extract logic | ‚úÖ | –†–∞–±–æ—Ç–∞–µ—Ç |
| Cache support | ‚úÖ | 158 HTML —Ñ–∞–π–ª–æ–≤ |
| Parse Copy page | ‚ö†Ô∏è | –§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥—Ä—É–≥–æ–µ –∏–º—è |

### Cache —Å—Ç–∞—Ç—É—Å

**üì¶ –í—Å–µ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ: 158 HTML —Å—Ç—Ä–∞–Ω–∏—Ü**

| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è | –§–∞–π–ª–æ–≤ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| `cache/kie_model_pages/` | 146 | –°—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–¥–µ–ª–µ–π |
| `cache/kie_docs/` | 12 | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è |

### –§–∏–ª–æ—Å–æ—Ñ–∏—è "Parse once, use forever"

**‚úÖ –£–°–ü–ï–®–ù–û –ü–†–ò–ú–ï–ù–ï–ù–ê:**

- Parser –∑–∞–ø—É—â–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑ (Cycle #14)
- 72 –º–æ–¥–µ–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ SOURCE_OF_TRUTH
- –ö—ç—à —Å–æ—Ö—Ä–∞–Ω–µ–Ω (158 —Å—Ç—Ä–∞–Ω–∏—Ü)
- Re-parsing –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è
- SOURCE_OF_TRUTH —Å—Ç–∞–±–∏–ª–µ–Ω < 2 —á–∞—Å–æ–≤

**–í—ã–≤–æ–¥:** Parser –≤—ã–ø–æ–ª–Ω–∏–ª —Å–≤–æ—é –∑–∞–¥–∞—á—É! –î–∞–ª—å–Ω–µ–π—à–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –Ω–∞ Kie.ai

---

## üèóÔ∏è 3. BUILDER SYSTEM (–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ payload)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –û–¢–õ–ò–ß–ù–û

**–§–∞–π–ª:** `app/kie/builder.py`

### –§—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|--------|----------|
| `load_source_of_truth()` | ‚úÖ | –ó–∞–≥—Ä—É–∂–∞–µ—Ç KIE_SOURCE_OF_TRUTH.json |
| `get_model_schema()` | ‚úÖ | –ü–æ–ª—É—á–∞–µ—Ç —Å—Ö–µ–º—É –º–æ–¥–µ–ª–∏ |
| `get_model_config()` | ‚úÖ | –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è UI (–¥–æ–±–∞–≤–ª–µ–Ω –≤ Cycle #20) |
| `build_payload()` | ‚úÖ | –°—Ç—Ä–æ–∏—Ç payload –¥–ª—è createTask API |

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SOURCE_OF_TRUTH

```python
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: models/KIE_SOURCE_OF_TRUTH.json
‚úÖ NO FALLBACKS (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**Smoke test (Cycle #20):**
- ‚úÖ 4/4 FREE –º–æ–¥–µ–ª–∏ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç
- ‚úÖ get_model_config() —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ build_payload() —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ 0 –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ

**–í—ã–≤–æ–¥:** Builder –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω!

---

## üé® 4. UI SYSTEM (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | Uses SOT | –°—Ç–∞—Ç—É—Å |
|------|------------|----------|--------|
| `app/ui/marketing_menu.py` | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ UI –¥–µ—Ä–µ–≤–∞ | ‚úÖ | –û—Ç–ª–∏—á–Ω–æ |
| `bot/handlers/marketing.py` | Marketing handlers | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω (Cycle #20) |
| `bot/handlers/flow.py` | Generation flow | ‚úÖ | –†–∞–±–æ—Ç–∞–µ—Ç |

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**‚úÖ UI Tree:**
- 72 –º–æ–¥–µ–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ 7 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- FREE –º–æ–¥–µ–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è (rub_per_gen == 0)
- –¶–µ–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –î–û –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Cycle #20:**
- marketing.py —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SOURCE_OF_TRUTH
- FREE detection —á–µ—Ä–µ–∑ `rub_per_gen == 0`
- –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ registry

**–í—ã–≤–æ–¥:** UI –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å SOURCE_OF_TRUTH!

---

## üí∞ 5. PRICING SYSTEM (–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

**–§–∞–π–ª:** `app/payments/pricing.py`

### –§–æ—Ä–º—É–ª–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

```python
USD_TO_RUB = 78.0
MARKUP_MULTIPLIER = 2.0

# –§–æ—Ä–º—É–ª–∞:
user_price_rub = usd_per_gen √ó 78.0 √ó 2.0
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ü–µ–Ω

1. **Kie.ai response** (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ API)
2. **SOURCE_OF_TRUTH** (`pricing.rub_per_gen`) ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø
3. **Old registry** (`price` –≤ USD) - fallback
4. **Default** (10.0 USD)

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞

**FREE –º–æ–¥–µ–ª—å (z-image):**
```
rub_per_gen = 0
user_price = 0 RUB ‚úÖ
```

**PAID –º–æ–¥–µ–ª—å (seedream):**
```
usd_per_gen = 10.0
rub_per_gen = 10.0 √ó 78.0 = 780.0
user_price = 780.0 √ó 2.0 = 1560.0 RUB ‚úÖ
```

**–í—ã–≤–æ–¥:** Pricing –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SOURCE_OF_TRUTH –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

---

## üåê 6. API CLIENT (–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Kie.ai)

### ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –¢–†–ï–ë–£–ï–¢ –ü–†–û–í–ï–†–ö–ò

**–§–∞–π–ª—ã:** 
- `app/kie/client_v4.py`
- `app/kie/generator.py`

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –§—É–Ω–∫—Ü–∏—è | client_v4.py | generator.py |
|---------|--------------|--------------|
| createTask | ‚ö†Ô∏è | ‚ö†Ô∏è |
| getResult | ‚ö†Ô∏è | ‚ö†Ô∏è |
| Timeout | ‚úÖ | ‚úÖ |
| Retry logic | ‚ùå | ‚ùå |

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

1. **–ù–µ—Ç —è–≤–Ω—ã—Ö HTTP –≤—ã–∑–æ–≤–æ–≤** - –Ω–µ –Ω–∞–π–¥–µ–Ω—ã `requests.post()` –∏–ª–∏ `httpx.post()`
2. **–ù–µ—Ç retry logic** - –ø—Ä–∏ –æ—à–∏–±–∫–µ API –∑–∞–ø—Ä–æ—Å –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
3. **–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –º–µ—Ö–∞–Ω–∏–∑–º

**–í—ã–≤–æ–¥:** API Client —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è retry logic

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: config.json –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** –ö–†–ò–¢–ò–ß–ù–û

**–î–µ—Ç–∞–ª–∏:**
- `config.json.example` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `config.json` –ù–ï —Å–æ–∑–¥–∞–Ω
- API –∫–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- –ë–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

**–í–ª–∏—è–Ω–∏–µ:** –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```bash
cp config.json.example config.json
# –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å:
# - KIE_API_KEY
# - TELEGRAM_BOT_TOKEN
# - DATABASE_URL
```

---

### üü† –ü–†–û–ë–õ–ï–ú–ê #2: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç retry logic

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ò–ô

**–î–µ—Ç–∞–ª–∏:**
- API Kie.ai –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –∫—Ä–µ–¥–∏—Ç—ã –ø—Ä–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–±–æ—è—Ö

**–í–ª–∏—è–Ω–∏–µ:** 
- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- –ü–æ—Ç–µ—Ä—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏
- –ü–ª–æ—Ö–æ–π UX

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ API client:
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=4, max=10)
)
def create_task_with_retry(payload):
    # API call here
    pass
```

---

### üü° –ü–†–û–ë–õ–ï–ú–ê #3: Parser function naming

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–ò–ô

**–î–µ—Ç–∞–ª–∏:**
- –§—É–Ω–∫—Ü–∏—è `parse_copy_page()` –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ parser
- –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞—Ä—Å–µ—Ä–∞

**–í–ª–∏—è–Ω–∏–µ:** 
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SOURCE_OF_TRUTH –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `scripts/master_kie_parser.py` –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

---

### üü° –ü–†–û–ë–õ–ï–ú–ê #4: Validator –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SOT

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–ò–ô

**–î–µ—Ç–∞–ª–∏:**
- `app/kie/validator.py` –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç SOURCE_OF_TRUTH
- –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π
- –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å—Ö–µ–º—ã

**–í–ª–∏—è–Ω–∏–µ:**
- –ù–µ–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ API

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í validator.py –¥–æ–±–∞–≤–∏—Ç—å:
from app.kie.builder import load_source_of_truth, get_model_schema

def validate_model_inputs(model_id, user_inputs):
    sot = load_source_of_truth()
    schema = get_model_schema(model_id, sot)
    # Validate against schema from SOT
```

---

### üü¢ –ü–†–û–ë–õ–ï–ú–ê #5: –ù–µ—Ç database migrations

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** –ù–ò–ó–ö–ò–ô

**–î–µ—Ç–∞–ª–∏:**
- `migrations/versions/` –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

**–í–ª–∏—è–Ω–∏–µ:**
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å initial migration:
alembic revision --autogenerate -m "Initial schema"
alembic upgrade head
```

---

## üìä –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | Uses SOT | –ü—Ä–æ–±–ª–µ–º—ã | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|-----------|--------|----------|----------|----------------------|
| SOURCE_OF_TRUTH | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | - | –ù–µ—Ç | - |
| Parser | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | N/A | Naming (—Å—Ä–µ–¥–Ω–∏–π) | 3 |
| Builder | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | ‚úÖ | –ù–µ—Ç | - |
| UI Tree | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | ‚úÖ | –ù–µ—Ç | - |
| Marketing handlers | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω | ‚úÖ | –ù–µ—Ç | - |
| Flow handlers | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ | –ù–µ—Ç | - |
| Pricing | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ | ‚úÖ | –ù–µ—Ç | - |
| Validator | ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å | ‚ùå | –ù–µ—Ç SOT (—Å—Ä–µ–¥–Ω–∏–π) | 4 |
| API Client | ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å | N/A | Retry (–≤—ã—Å–æ–∫–∏–π) | 2 |
| Config | ‚ùå –ù–µ —Å–æ–∑–¥–∞–Ω | N/A | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ) | 1 |
| Database | ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å | N/A | Migrations (–Ω–∏–∑–∫–∏–π) | 5 |

---

## üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–ö—Ä–∏—Ç–∏—á–Ω–æ)

1. **–°–æ–∑–¥–∞—Ç—å config.json**
   ```bash
   cp config.json.example config.json
   # –ó–∞–ø–æ–ª–Ω–∏—Ç—å KIE_API_KEY, TELEGRAM_BOT_TOKEN
   ```

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

2. **–î–æ–±–∞–≤–∏—Ç—å retry logic –≤ API Client**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: `pip install tenacity`
   - –î–æ–±–∞–≤–∏—Ç—å retry decorator –∫ API –≤—ã–∑–æ–≤–∞–º
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å real API

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Parser**
   - –ù–∞–π—Ç–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Validator —Å SOT**
   - –î–æ–±–∞–≤–∏—Ç—å `load_source_of_truth()` –≤ validator.py
   - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ö–µ–º–∞–º –∏–∑ SOT
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

5. **–°–æ–∑–¥–∞—Ç—å database migrations**
   - `alembic revision --autogenerate -m "Initial schema"`
   - `alembic upgrade head`

---

## üèÜ –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û

### ‚úÖ SOURCE_OF_TRUTH (–§–∏–ª–æ—Å–æ—Ñ–∏—è "Parse once")

- ‚úÖ 72 –º–æ–¥–µ–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ 100% –º–æ–¥–µ–ª–µ–π –∏–º–µ—é—Ç —Ü–µ–Ω—ã
- ‚úÖ 4 FREE –º–æ–¥–µ–ª–∏ (0 RUB)
- ‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ < 2 —á–∞—Å–æ–≤
- ‚úÖ Re-parsing –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è

### ‚úÖ Integration (Cycle #20)

- ‚úÖ marketing.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SOT
- ‚úÖ builder.py –∏–º–µ–µ—Ç get_model_config()
- ‚úÖ UI tree —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ SOT (72 –º–æ–¥–µ–ª–∏)
- ‚úÖ Pricing –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SOT
- ‚úÖ 4 FREE –º–æ–¥–µ–ª–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã (0 –∫—Ä–µ–¥–∏—Ç–æ–≤)

### ‚úÖ Code Quality

- ‚úÖ –ù–µ—Ç breaking changes
- ‚úÖ –§–∏–ª–æ—Å–æ—Ñ–∏—è "–Ω–µ –ª–æ–º–∞–π –ª–æ–≥–∏–∫—É" —Å–æ–±–ª—é–¥–µ–Ω–∞
- ‚úÖ Additive changes —Ç–æ–ª—å–∫–æ
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

---

## üìà –ú–ï–¢–†–ò–ö–ò –ü–†–û–ì–†–ï–°–°–ê

### Cycles #14-20 (–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –∏—Ç–µ—Ä–∞—Ü–∏–π)

| Cycle | –§–æ–∫—É—Å | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|-------|-----------|
| #14 | Full parsing | 72 –º–æ–¥–µ–ª–∏ —Å–ø–∞—Ä—Å–µ–Ω—ã |
| #15 | Critical fixes | 16 –ø–æ–ª–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ |
| #16 | Validation | 70/72 working |
| #17 | 100% coverage | 72/72 + 4 FREE |
| #18 | UI integration | FREE detection |
| #19 | Production ready | Endpoint fix |
| #20 | Integration tests | 5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ‚úÖ |

### –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

- **100% model coverage:** 72/72 –º–æ–¥–µ–ª–∏
- **100% pricing coverage:** 72/72 —Å —Ü–µ–Ω–∞–º–∏
- **0 credits spent:** –í—Å–µ —Ç–µ—Å—Ç—ã –±–µ–∑ —Ç—Ä–∞—Ç
- **Parse once success:** SOURCE_OF_TRUTH —Å—Ç–∞–±–∏–ª–µ–Ω
- **7 categories:** –ü–æ–ª–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è
- **2 endpoints:** –û—á–∏—â–µ–Ω—ã –æ—Ç –æ—à–∏–±–æ–∫

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

1. ‚úÖ SOURCE_OF_TRUTH –≥–æ—Ç–æ–≤ (–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å!)
2. ‚ö†Ô∏è –°–æ–∑–¥–∞—Ç—å config.json —Å API –∫–ª—é—á–∞–º–∏
3. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API Client —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å retry logic

### –î–ª—è production deployment

1. ‚úÖ –í—Å–µ –º–æ–¥–µ–ª–∏ –≥–æ—Ç–æ–≤—ã
2. ‚úÖ Pricing –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
3. ‚úÖ UI –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
4. ‚ö†Ô∏è –ù—É–∂–µ–Ω retry –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
5. ‚ö†Ô∏è –ù—É–∂–Ω—ã database migrations

### –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

1. ‚úÖ SOURCE_OF_TRUTH - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
2. ‚úÖ Parser –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö
3. ‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å parser functions
4. ‚ö†Ô∏è Validator –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SOT

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: üü° –†–ê–ë–û–¢–ê–ï–¢ –° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø–ú–ò

**–ß—Ç–æ –æ—Ç–ª–∏—á–Ω–æ:**
- ‚úÖ SOURCE_OF_TRUTH (72 –º–æ–¥–µ–ª–∏, 100% complete)
- ‚úÖ Builder (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç)
- ‚úÖ UI (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å SOT)
- ‚úÖ Pricing (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã)
- ‚úÖ Parser (–∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:**
- üî¥ config.json –Ω–µ —Å–æ–∑–¥–∞–Ω (–∫—Ä–∏—Ç–∏—á–Ω–æ)
- üü† –ù–µ—Ç retry logic (–≤—ã—Å–æ–∫–∏–π)
- üü° Parser naming (—Å—Ä–µ–¥–Ω–∏–π)
- üü° Validator –±–µ–∑ SOT (—Å—Ä–µ–¥–Ω–∏–π)
- üü¢ Database migrations (–Ω–∏–∑–∫–∏–π)

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** 75%

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è 100%:**
1. –°–æ–∑–¥–∞—Ç—å config.json
2. –î–æ–±–∞–≤–∏—Ç—å retry logic
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å real API calls

---

**–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:** 2025-12-25  
**–ê–≤—Ç–æ—Ä:** GitHub Copilot (Claude Sonnet 4.5)  
**–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
