#!/usr/bin/env python3















"""















Render-first entrypoint ????????????????? Telegram Bot















?????????????????????????????????? ???????????????????????????? ????????????????????????????? ????????????????? ???????????????????????????????????????? ???????????? Render.com (Web Service ?????????????????? Worker)















"""































import sys















import os















import logging















import asyncio















import time















from pathlib import Path















from typing import Optional































# ???????????????????????????????????????????????????? ????????????????????????????????????????????? ???????????????????????????????????????????????????????? ?????? ????????????????????? (???????????????????????????????????????? ????????????????? Render)















project_root = Path(__file__).parent.absolute()















if str(project_root) not in sys.path:















    sys.path.insert(0, str(project_root))































# ?????????????????????????????????????????????????????????????? ????????????????????????????????????????????????????????????????? ????????????????????????? ?????????????????????????????????????????????? ????????????????????????????????? ?????????????????????????????????????????















from app.utils.logging_config import setup_logging, get_logger































setup_logging(level=logging.INFO)















logger = get_logger(__name__)































# ????????????????????????????????????????????????????????? ??????????????????????????????????????????????????????????















_start_time = time.time()















_application: Optional[object] = None















































def log_env_snapshot():















    """???????????????????????????????????????????? snapshot ENV ????????????????????????????????????????????????????????? ?????????????????? ?????????????????????????????????????????????"""















    env_vars = {















        "PORT": os.getenv("PORT", "not set"),















        "RENDER": os.getenv("RENDER", "not set"),















        "ENV": os.getenv("ENV", "not set"),















        "BOT_MODE": os.getenv("BOT_MODE", "not set"),















        "STORAGE_MODE": os.getenv("STORAGE_MODE", "not set"),















        "DATABASE_URL": "[SET]" if os.getenv("DATABASE_URL") else "[NOT SET]",















        "TELEGRAM_BOT_TOKEN": "[SET]" if os.getenv("TELEGRAM_BOT_TOKEN") else "[NOT SET]",















        "KIE_API_KEY": "[SET]" if os.getenv("KIE_API_KEY") else "[NOT SET]",















        "KIE_API_URL": os.getenv("KIE_API_URL", "not set"),















        "TEST_MODE": os.getenv("TEST_MODE", "not set"),















        "DRY_RUN": os.getenv("DRY_RUN", "not set"),















        "ALLOW_REAL_GENERATION": os.getenv("ALLOW_REAL_GENERATION", "not set"),















    }















    















    logger.info("=" * 60)















    logger.info("ENVIRONMENT VARIABLES SNAPSHOT")















    logger.info("=" * 60)















    for key, value in sorted(env_vars.items()):















        logger.info(f"{key}={value}")















    logger.info("=" * 60)















































def ensure_data_directory(data_dir: str) -> bool:















    """???????????????????????????????????????????????????????????? ??????????????????????????????????????????????? data ????????????????????????????????????????????????????????? ?????? ?????????????????????????????????????????????????? ????????????????????????????? ???????????????????????????????????"""















    try:















        data_path = Path(data_dir)















        data_path.mkdir(parents=True, exist_ok=True)















        















        # ?????????????????????????????????????????????????? ????????????????????????????? ???????????????????????????????????















        test_file = data_path / ".write_test"















        try:















            test_file.write_text("test")















            test_file.unlink()















            logger.info(f"[OK] Data directory writable: {data_dir}")















            return True















        except Exception as e:















            logger.error(f"[FAIL] Cannot write to data directory {data_dir}: {e}")















            return False















    except Exception as e:















        logger.error(f"[FAIL] Cannot create data directory {data_dir}: {e}")















        return False















































def load_and_validate_settings():















    """?????????????????????????????????????????????????? ?????? ????????????????????????????????????????????????????????? ??????????????????????????????????????????????????? ???????????? ENV"""















    from app.config import get_settings















    















    logger.info("=" * 60)















    logger.info("BOT STARTING")















    logger.info("=" * 60)















    















    try:















        # ????????????????????????????????????????????? ENV snapshot















        log_env_snapshot()















        















        # ??????????????????????????????????????????????????? ??????????????????????????????????????????????????? ????? ???????????????????????????????????????????????????????????















        settings = get_settings(validate=True)















        















        # Startup banner















        logger.info("=" * 60)















        logger.info("STARTUP BANNER")















        logger.info("=" * 60)















        logger.info(f"Python version: {sys.version.split()[0]}")















        logger.info(f"Working directory: {os.getcwd()}")















        logger.info(f"Process ID: {os.getpid()}")















        logger.info(f"Render environment: {os.getenv('RENDER', 'not detected')}")















        logger.info(f"Storage mode: {settings.get_storage_mode()}")















        logger.info(f"KIE mode: {'stub' if os.getenv('KIE_STUB') else ('real' if settings.kie_api_key else 'disabled')}")















        logger.info(f"Bot mode: {settings.bot_mode}")















        logger.info(f"Port: {settings.port if settings.port > 0 else 'disabled (Worker mode)'}")















        logger.info(f"Data directory: {settings.data_dir}")















        logger.info("=" * 60)















        















        # ?????????????????????????????????????????????????? data directory















        if not ensure_data_directory(settings.data_dir):















            logger.error("[FAIL] Data directory not writable, exiting")















            sys.exit(1)















        















        return settings















    except ValueError as e:















        logger.error("=" * 60)















        logger.error("CONFIGURATION VALIDATION FAILED")















        logger.error("=" * 60)















        logger.error(str(e))















        logger.error("=" * 60)















        sys.exit(1)















    except SystemExit:















        raise















    except Exception as e:















        from app.utils.logging_config import log_error_with_stacktrace















        log_error_with_stacktrace(logger, e, "Failed to load settings")















        sys.exit(1)















































async def build_application(settings):















    """???????????????????????????????????????? ?????? ?????????????????????????????????????????????????????????????? Telegram Application"""















    global _application















    















    try:















        # ????????????????????????????????????????: ????????????????????????????????? bot_kie ????? ???????????????????????????? ????????????????????????????????????????????????????? ??????????????????????















        create_bot_application = None















        try:















            from bot_kie import create_bot_application















        except ImportError as e1:















            logger.warning(f"[BUILD] Failed to import from bot_kie: {e1}, trying app.bot_kie")















            try:















                # ??????????????????????????????????????? ?????????????????????????????????? ???????????? app.bot_kie (??????????????????????? ????????????????? ????????????????????? ??????????????????????????????????????)















                from app.bootstrap import create_application as create_bot_application















                logger.info("[BUILD] Using app.bootstrap.create_application")















            except ImportError as e2:















                logger.error(f"[BUILD] Failed to import from app.bootstrap: {e2}")















                logger.error(f"[BUILD] sys.path: {sys.path}")















                logger.error(f"[BUILD] Current dir: {os.getcwd()}")















                logger.error(f"[BUILD] Script dir: {Path(__file__).parent}")















                # ??????????????????????????????????????? ?????????????????????????????????????????????? ????????????????????? ???????????????????????















                bot_kie_path = Path(__file__).parent / "bot_kie.py"















                if bot_kie_path.exists():















                    logger.info(f"[BUILD] bot_kie.py exists at {bot_kie_path}")















                    # ??????????????????????????????????????? ?????????????????????????????????? ?????????????????????????????????? ???????????????????????????? importlib















                    import importlib.util















                    spec = importlib.util.spec_from_file_location("bot_kie", bot_kie_path)















                    if spec and spec.loader:















                        bot_kie_module = importlib.util.module_from_spec(spec)















                        spec.loader.exec_module(bot_kie_module)















                        create_bot_application = getattr(bot_kie_module, "create_bot_application", None)















                        if create_bot_application:















                            logger.info("[BUILD] Successfully loaded create_bot_application via importlib")















                else:















                    logger.error(f"[BUILD] bot_kie.py NOT found at {bot_kie_path}")















                if not create_bot_application:















                    raise ImportError(f"Could not import create_bot_application: {e1}, {e2}")















        















        if not create_bot_application:















            raise ImportError("create_bot_application is None after import attempts")















        















        logger.info("[BUILD] Creating Telegram Application...")















        _application = await create_bot_application(settings)















        logger.info("[BUILD] Application created successfully")















        















        return _application















    except (AttributeError, NameError) as e:















        logger.warning(f"[BUILD] create_bot_application not found: {e}, using legacy initialization")















        return None















    except ImportError as e:















        logger.error(f"[BUILD] Import error: {e}")















        logger.warning("[BUILD] Using legacy bot_kie.main() initialization")















        return None















    except Exception as e:















        from app.utils.logging_config import log_error_with_stacktrace















        log_error_with_stacktrace(logger, e, "Failed to build application")















        raise















































async def start_health_server(port: int) -> bool:















    """?????????????????????????????????????????????????? healthcheck ????????????????????????????????? ?????? ????????????????? ???????????? event loop"""















    if port == 0:















        logger.info("[HEALTH] PORT not set, skipping healthcheck server (Worker mode)")















        return False















    















    try:















        from app.utils.healthcheck import start_health_server















        return await start_health_server(port=port)















    except Exception as e:















        logger.warning(f"[HEALTH] Failed to start health server: {e}")















        return False















































async def run(settings, application):















    """?????????????????????????????????????????????????? ??????????????????????? (polling ?????????????????? webhook)"""















    global _application















    















    # Singleton lock ???????????????????????????????????? ????????????????????? ???????????????????????????????????????? ?????????? ??????????????????????????? async ??????????????????????????????????????????????















    from app.utils.singleton_lock import acquire_singleton_lock, release_singleton_lock















    















    try:
        lock_acquired = await acquire_singleton_lock()
        if not lock_acquired:
            logger.warning("[LOCK] Singleton lock not acquired - continuing in passive mode (database may be unavailable)")
    except Exception as e:
        logger.warning(f"[LOCK] Failed to acquire singleton lock (database may be unavailable): {e} - continuing anyway")















    















    try:















        # ??????????????????????????????????????????????????? healthcheck ????????????????????????????????? (??????????????????????? PORT ?????????????????????????????? - Web Service ?????????????????????????????)















        if settings.port > 0:















            logger.info(f"[HEALTH] Starting healthcheck server on port {settings.port} (Web Service mode)")















            await start_health_server(port=settings.port)















        else:















            logger.info("[HEALTH] Port not set, running in Worker mode (no healthcheck)")















        















        if application is None:















            # ???????????????????????????????????????????????????????? ???????????????????????????????? ?????????????????????????????????? ???????????????????????????? bot_kie.main()















            logger.info("[RUN] Using legacy bot_kie.main() initialization")















            try:















                from bot_kie import main as bot_main















                await bot_main()















            except ImportError as e:















                logger.error(f"[RUN] Failed to import bot_kie.main: {e}")















                logger.error("[RUN] Falling back to app.main")















                from app.main import main as app_main















                await app_main()















        else:















            # ???????????????????????????????????????????????????????? ????????????????????????????? ??????????????????????????????????















            logger.info("[RUN] Initializing application...")















            await application.initialize()















            await application.start()















            















            logger.info("=" * 60)















            logger.info("BOT READY")















            logger.info("=" * 60)















            logger.info("Handlers registered and application started")















            















            # ??????????????????????????????????????????????????? polling ?????????????????? webhook















            if settings.bot_mode == "webhook":















                if not settings.webhook_url:















                    logger.warning("[WEBHOOK] WEBHOOK_URL not set for webhook mode - falling back to polling")
                    settings.bot_mode = "polling"















                    sys.exit(1)















                await application.bot.set_webhook(settings.webhook_url)















                logger.info(f"[RUN] Webhook set to {settings.webhook_url}")















                logger.info("[RUN] Webhook mode - bot is ready")















            else:















                # Polling mode - ?????????????????????????????????????????????????????????? ?????????????????????????????????? ????? ?????????????????????????????????????????????????????????? ??????????????????????????????????????????????????????????















                logger.info("[RUN] Starting polling...")















                















                # ????????????????????????????????????????: ?????????????????????????????????????????????? ????????????????????????????? ?????????????????????????????????????????????? polling ????????????????? ??????????????????????????????????????????????????????????????????????????????? ??????????????????????????????????????????????????????????















                logger.info("[RUN] Waiting 15 seconds to avoid conflicts with previous instance...")















                await asyncio.sleep(15)















                















                # ????????????????????????????????????????: ???????????????????????????????????????? webhook ????????????????????????? ?????????????????????????????????????????????? polling















                try:















                    await application.bot.delete_webhook(drop_pending_updates=True)















                    webhook_info = await application.bot.get_webhook_info()















                    if webhook_info.url:















                        logger.warning(f"[RUN] Webhook still present: {webhook_info.url}")















                    else:















                        logger.info("[RUN] Webhook removed successfully")















                except Exception as e:















                    logger.warning(f"[RUN] Error removing webhook: {e}")















                    # ?????????????????????????????????????????????????? ???????????? ??????????????????????????????????????????????















                    from telegram.error import Conflict















                    if isinstance(e, Conflict) or "Conflict" in str(e) or "409" in str(e):















                        logger.error("[RUN] Conflict detected while removing webhook - exiting")















                        from app.bot_mode import handle_conflict_gracefully















                        handle_conflict_gracefully(e if isinstance(e, Conflict) else Conflict(str(e)), "polling")















                        return















                















                # ????????????????????????????????????????: ???????????????????????????????????????????????????? ????????????????????????????????????????????????????????? ??????????????????????????????????? ????????????????? updater















                async def handle_updater_error(update, context):















                    """???????????????????????????????????????????????????????? ??????????????????????????????????? ????????????????? updater polling loop"""















                    error = context.error















                    error_msg = str(error) if error else ""















                    















                    from telegram.error import Conflict















                    if isinstance(error, Conflict) or "Conflict" in error_msg or "terminated by other getUpdates" in error_msg or "409" in error_msg:















                        logger.error(f"[UPDATER] 409 CONFLICT in updater loop: {error_msg}")















                        logger.error("[UPDATER] Stopping updater and exiting...")















                        















                        # ??????????????????????????????????????????????????????????????????????????? updater ????????????????????????????????????????????????????????????















                        try:















                            if application.updater and application.updater.running:















                                await application.updater.stop()















                                logger.info("[UPDATER] Updater stopped")















                        except Exception as e:















                            logger.warning(f"[UPDATER] Error stopping updater: {e}")















                        















                        # ??????????????????????????????????????????????????????????????????????????? application















                        try:















                            await application.stop()















                            await application.shutdown()















                        except:















                            pass















                        















                        # ???????????????????????????????????????????????????????????????? lock ?????? ????????????????????????????????????????















                        try:















                            from app.locking.single_instance import release_single_instance_lock















                            release_single_instance_lock()















                        except:















                            pass















                        















                        from app.bot_mode import handle_conflict_gracefully















                        handle_conflict_gracefully(error if isinstance(error, Conflict) else Conflict(error_msg), "polling")















                        import os















                        os._exit(0)















                















                # ???????????????????????????????????????????????????? ????????????????????????????????????????????????????????? ??????????????????????????????????? ????????????????? updater















                application.add_error_handler(handle_updater_error)















                















                # ????????????????????????????????????????: ?????????????????????????????????????????????????? ?????????????????????????????????????????????? ????????????????????????? ?????????????????????????????????????????????? polling















                logger.info("[RUN] Checking for conflicts before polling start...")















                try:















                    # ??????????????????????????????????????????? ??????????????????????????????????????? ???????????????????????????????????????????? getUpdates ????????????????? ?????????????????????????????????????????????? ????????????????????????????????????????????????????















                    test_updates = await application.bot.get_updates(limit=1, timeout=1)















                    logger.info("[RUN] Pre-flight check passed: no conflicts detected")















                except Exception as test_e:















                    from telegram.error import Conflict















                    error_msg = str(test_e)















                    if isinstance(test_e, Conflict) or "Conflict" in error_msg or "409" in error_msg or "terminated by other getUpdates" in error_msg:















                        logger.error(f"[RUN] ?????????????????? CONFLICT DETECTED in pre-flight check: {error_msg}")















                        logger.error("[RUN] Another bot instance is already polling - exiting")















                        try:















                            await application.stop()















                            await application.shutdown()















                        except:















                            pass















                        from app.bot_mode import handle_conflict_gracefully















                        handle_conflict_gracefully(test_e if isinstance(test_e, Conflict) else Conflict(error_msg), "polling")















                        return















                    else:















                        logger.warning(f"[RUN] Pre-flight check warning (non-conflict): {test_e}")















                















                # ????????????????????????????????????????: ??????????????????????????????????????????????????? polling ????? ?????????????????????????????????????????????????????????? ??????????????????????????????????????????????????????????















                try:















                    await application.updater.start_polling(drop_pending_updates=True)















                    logger.info("[RUN] Polling started successfully")















                except Exception as e:















                    from telegram.error import Conflict















                    error_msg = str(e)















                    if isinstance(e, Conflict) or "Conflict" in error_msg or "409" in error_msg or "terminated by other getUpdates" in error_msg:















                        logger.error(f"[RUN] ?????????????????? CONFLICT DETECTED during polling start: {error_msg}")















                        logger.error("[RUN] Stopping updater and exiting immediately...")















                        















                        # ??????????????????????????????????????????????????????????????????????????? updater ????????????????????????????????????????????????????????????















                        try:















                            if application.updater and application.updater.running:















                                await application.updater.stop()















                                logger.info("[RUN] Updater stopped")















                        except Exception as stop_e:















                            logger.warning(f"[RUN] Error stopping updater: {stop_e}")















                        















                        # ??????????????????????????????????????????????????????????????????????????? application















                        try:















                            await application.stop()















                            await application.shutdown()















                        except:















                            pass















                        















                        # ???????????????????????????????????????????????????????????????? lock















                        try:















                            from app.locking.single_instance import release_single_instance_lock















                            release_single_instance_lock()















                        except:















                            pass















                        















                        from app.bot_mode import handle_conflict_gracefully















                        handle_conflict_gracefully(e if isinstance(e, Conflict) else Conflict(error_msg), "polling")















                        import os















                        os._exit(0)  # ???????????????????????????????????????????????????????????????? ????????????????????????????















                    else:















                        raise  # Re-raise non-Conflict errors















            















            # ??????????????????????? ????????????????????????????????????????????????????















            try:















                await asyncio.Event().wait()  # ??????????????????????? ??????????????????????????????????????????????????????????















            except KeyboardInterrupt:















                logger.info("[STOP] Bot stopped by user")















            finally:















                await application.stop()















                await application.shutdown()















    except KeyboardInterrupt:















        logger.info("[STOP] Bot stopped by user")















        sys.exit(0)















    except SystemExit:















        raise















    except Exception as e:















        from app.utils.logging_config import log_error_with_stacktrace















        log_error_with_stacktrace(logger, e, "Fatal error during bot run")















        logger.error("[FAIL] Bot failed to run. Check logs above for details.")















        sys.exit(1)















    finally:















        # ??????????????????????????????????????????????????????????????????????????? healthcheck ?????????????????????????????????













































        















        # ???????????????????????????????????????????????????????????????? singleton lock















        await release_singleton_lock()















































async def main():















    """???????????????????????????????????????? async ??????????????????????????????????????"""















    try:















        # 1. ??????????????????????????????????????????????????? ?????? ?????????????????????????????????????????????????????????? ???????????????????????????????????????????????????















        settings = load_and_validate_settings()















        















        # 2. ????????????????????????????????????????? application















        application = await build_application(settings)















        















        # 3. ??????????????????????????????????????????????????? ???????????????????????















        await run(settings, application)















    except SystemExit:















        raise















    except Exception as e:















        from app.utils.logging_config import log_error_with_stacktrace















        log_error_with_stacktrace(logger, e, "Fatal error in main")















        sys.exit(1)















































if __name__ == "__main__":















    # ??????????????????????????????????????????????????? async main















    try:















        asyncio.run(main())















    except KeyboardInterrupt:















        logger.info("[STOP] Bot stopped by user")















        sys.exit(0)















    except SystemExit:















        raise















    except Exception as e:















        from app.utils.logging_config import log_error_with_stacktrace















        log_error_with_stacktrace(logger, e, "Fatal error in asyncio.run")















        sys.exit(1)































