## Render Shared Database Rules

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–î

1. **–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π `process.env.DATABASE_URL` (Python: `os.getenv('DATABASE_URL')`)**
   - Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ inject–∏—Ç DATABASE_URL –∏–∑ "Connections" –≤ Environment Variables
   - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ª–æ–∫–∞–ª—å–Ω—ã–µ –ë–î –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã
   - –¢–æ–ª—å–∫–æ shared PostgreSQL –Ω–∞ Render –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

2. **Connection Pooling –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù**
   - Python: –∏—Å–ø–æ–ª—å–∑—É–π `asyncpg.create_pool()` –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π
   - Node.js: –∏—Å–ø–æ–ª—å–∑—É–π `pg.Pool()` —Å connectionString
   - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

3. **Environment Variables**
   - –ü—Ä–∏ –¥–µ–ø–ª–æ–µ: Render auto-inject–∏—Ç DATABASE_URL –∏–∑ "Connections" —Ç–≤–æ–µ–π –ë–î
   - –õ–æ–∫–∞–ª—å–Ω–æ: —Å–æ–∑–¥–∞–π `.env` —Å `DATABASE_URL=postgres://...` –∏–∑ Render Dashboard
   - –§–æ—Ä–º–∞—Ç: `postgresql://user:password@host:port/database`

4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π parameterized queries –ø—Ä–æ—Ç–∏–≤ SQL injection
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π f-strings –∏–ª–∏ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é –¥–ª—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–π `%s` (psycopg2) –∏–ª–∏ `$1, $2...` (asyncpg) –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üìã –ü–†–ò–ú–ï–†–´ –ö–û–î–ê

### Python (asyncpg) - –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è async –±–æ—Ç–æ–≤

```python
import os
import asyncpg
from typing import Optional

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
_pool: Optional[asyncpg.Pool] = None

async def get_pool() -> asyncpg.Pool:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î."""
    global _pool
    if _pool is None:
        DATABASE_URL = os.getenv('DATABASE_URL')
        if not DATABASE_URL:
            raise ValueError("DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        _pool = await asyncpg.create_pool(
            DATABASE_URL,
            min_size=1,
            max_size=10,
            command_timeout=60
        )
    return _pool

async def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    pool = await get_pool()
    # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏/—Å—Ö–µ–º—É
    async with pool.acquire() as conn:
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ —Ç.–¥.
        pass

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
async def get_user(user_id: int):
    pool = await get_pool()
    async with pool.acquire() as conn:
        row = await conn.fetchrow(
            "SELECT * FROM users WHERE id = $1",
            user_id
        )
        return dict(row) if row else None
```

### Python (psycopg2) - –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```python
import os
import psycopg2
from psycopg2.pool import SimpleConnectionPool
from contextlib import contextmanager

_pool: Optional[SimpleConnectionPool] = None

def get_connection_pool():
    """–°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î."""
    global _pool
    if _pool is None:
        DATABASE_URL = os.getenv('DATABASE_URL')
        if not DATABASE_URL:
            raise ValueError("DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        _pool = SimpleConnectionPool(
            minconn=1,
            maxconn=10,
            dsn=DATABASE_URL
        )
    return _pool

@contextmanager
def get_db_connection():
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."""
    pool = get_connection_pool()
    conn = pool.getconn()
    try:
        yield conn
        conn.commit()
    except Exception as e:
        conn.rollback()
        raise
    finally:
        pool.putconn(conn)

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def get_user(user_id: int):
    with get_db_connection() as conn:
        with conn.cursor() as cur:
            cur.execute(
                "SELECT * FROM users WHERE id = %s",
                (user_id,)  # Parameterized query
            )
            return cur.fetchone()
```

### Node.js (pg)

```javascript
const { Pool } = require('pg');

const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false  // –î–ª—è Render PostgreSQL
    },
    max: 10,  // –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
async function getUser(userId) {
    const result = await pool.query(
        'SELECT * FROM users WHERE id = $1',
        [userId]  // Parameterized query
    );
    return result.rows[0];
}
```

---

## üöÄ –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –î–ï–ü–õ–û–Æ

### 1. Render Dashboard ‚Üí Service ‚Üí Environment
   - –ù–∞–∂–º–∏ "Connect to Database"
   - –í—ã–±–µ—Ä–∏ –æ–±—â—É—é PostgreSQL –ë–î
   - Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç `DATABASE_URL` –≤ Environment Variables

### 2. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
   - –°–æ–∑–¥–∞–π `.env` —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
   - –î–æ–±–∞–≤—å: `DATABASE_URL=postgresql://user:password@host:port/database`
   - –ü–æ–ª—É—á–∏ DATABASE_URL –∏–∑ Render Dashboard ‚Üí Database ‚Üí Connections

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   ```python
   # Python
   import os
   DATABASE_URL = os.getenv('DATABASE_URL')
   print(f"Database: {DATABASE_URL.split('@')[1] if '@' in DATABASE_URL else 'Not set'}")
   ```

---

## üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ò

**Render PostgreSQL Database:**
- Hostname: `dpg-d50f1hvgi27c73ajfos0-a`
- Port: `5432`
- Database: `telegrambot_j6cd`
- Username: `telegrambot_j6cd_user`
- Connection String: –ü–æ–ª—É—á–∏ –∏–∑ Render Dashboard ‚Üí Database ‚Üí Connections

**–í–ê–ñ–ù–û:** –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `DATABASE_URL` –∏–∑ environment variables!

---

## ‚ö†Ô∏è –ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò

1. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ª–æ–∫–∞–ª—å–Ω—ã–µ –ë–î –¥–ª—è dev/prod**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ shared Render PostgreSQL

2. ‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä—è–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è host/port/user/password**
   - ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `DATABASE_URL` –∏–∑ environment

3. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π connection pool

4. ‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π f-strings –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö**
   - ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π parameterized queries

5. ‚ùå **–ù–ï –∑–∞–±—ã–≤–∞–π –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π context managers –∏–ª–∏ async with

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

- –î–ª—è Telegram –±–æ—Ç–æ–≤ (async): –∏—Å–ø–æ–ª—å–∑—É–π `asyncpg`
- –î–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–≤ (sync): –∏—Å–ø–æ–ª—å–∑—É–π `psycopg2`
- –î–ª—è Node.js: –∏—Å–ø–æ–ª—å–∑—É–π `pg` —Å Pool
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π connection pooling
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –õ–æ–≥–∏—Ä—É–π –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

---

**–ü–†–ê–í–ò–õ–û #1:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `DATABASE_URL` –∏–∑ environment variables, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!

