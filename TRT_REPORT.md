## 2026-02-09: No-silence SSOT + Render handler registration
**Причина (root cause):**
- В webhook-пути Render при fallback на `app.bootstrap.create_application` не регистрировались `ConversationHandler`/message handlers, поэтому после выбора модели текстовые сообщения не попадали в обработчики. 
- Состояние сессии (`waiting_for/current_param`) велось в глобальном словаре без единого слоя доступа/логов, что мешало диагностике и маршрутизации. 

**Было → стало (ключевые изменения):**
- **Session SSOT:** глобальный `user_sessions` → `SessionStore` с логами `SESSION_GET/SET/MISS`, единый источник данных через `DependencyContainer`. 
- **Handler registration:** в `main_render.py` bootstrap-путь теперь регистрирует handlers через `_register_all_handlers_internal`, чтобы `ConversationHandler` и message handlers всегда активны. 
- **No-silence fallback:** добавлен финальный обработчик `unhandled_update_fallback` для TEXT/PHOTO/AUDIO/DOCUMENT с `UNHANDLED_UPDATE` логами и кнопкой “Reset step”. 
- **UX:** при запросе параметров теперь всегда отображается free counter + “Reset step” в клавиатурах. 

**Затронутые файлы:**
- `app/session_store.py`, `app/bootstrap.py`
- `bot_kie.py`, `main_render.py`
- `tests/test_no_silence_prompt_flow.py`

**Проверка (команды):**
- `python scripts/verify_project.py`
- `pytest -q`
- `python scripts/verify_button_coverage.py`

## 2026-02-08: Production-ready no-lock webhook + анти-мусор URL + no-silence
**Было → стало (ключевые изменения):**
- **Webhook без БД:** при `BOT_MODE=webhook` без `DATABASE_URL` требовался DB lock. **Стало:** разрешён старт при `STORAGE_MODE=github` или `DISABLE_DB_LOCKS=1` с “no-lock mode” и `LOCK_DISABLED_NO_DB`. 
- **Анти-мусор URL:** странные URL (например, `tempfile.aiquickdraw.comhttps:///...`) ломали доставку. **Стало:** нормализация обрезает к первому http/https, восстанавливает host из `KIE_API_URL`, валидирует и даёт понятную ошибку пользователю. 
- **No-silence callbacks:** неизвестные callback’и и ошибки теперь всегда дают ответ и видимое сообщение с correlation_id. 

**Причина:** убрать молчание и падения в webhook без БД + защитить UX от битых ссылок результатов.

**Затронутые файлы:**
- `main_render.py`, `app/config.py`, `app/utils/singleton_lock.py`
- `app/utils/url_normalizer.py`, `app/delivery/result_delivery.py`, `app/generations/telegram_sender.py`
- `bot_kie.py`, `tests/test_main_menu.py`, `tests/test_url_normalizer.py`
- `tests/test_webhook_without_db_github_storage.py`, `app/generations/universal_engine.py`

**Проверка (команды):**
- `python scripts/verify_project.py`
- `pytest -q`
- `python scripts/verify_button_coverage.py`

**Как проверить на Render (быстро):**
1. Установить `BOT_MODE=webhook`, `STORAGE_MODE=github`, удалить `DATABASE_URL` (или `DISABLE_DB_LOCKS=1`).
2. Убедиться, что `/health` возвращает `"webhook_route_registered": true`.
3. Нажать любую кнопку — должна быть мгновенная реакция (без бесконечного “Loading…”).
## 2026-02-07: Webhook без БД для GitHub storage + fallback lock
**Было → стало (ключевые изменения):**
- **Webhook + DATABASE_URL:** запуск падал с `CONFIG_DB_REQUIRED` при `BOT_MODE=webhook` без БД. **Стало:** при `STORAGE_MODE=github` webhook разрешён без БД и используется file lock (fallback). 
- **Singleton lock:** ранее только PostgreSQL advisory lock. **Стало:** добавлен file lock для режима GitHub storage, строгий лог `LOCK_MODE` и фиксация деградации. 
- **UX деградации:** пользователи не получали сообщения при снижении надёжности. **Стало:** добавлено UX-уведомление в главном меню при деградации lock. 
- **Конфиг и тесты:** валидация больше не блокирует webhook в `github` режиме; тесты обновлены. 

**Причина:** убрать стартовую смерть бота на Render без БД и дать понятную деградацию.

**Затронутые файлы:**
- `main_render.py`, `app/utils/singleton_lock.py`, `app/config.py`, `bot_kie.py`
- `tests/test_webhook_db_requirement.py`
## 2026-02-05: P0 production readiness — locks, SSOT output media, UX back
**Было → стало (ключевые изменения):**
- **Unused handler retry_generate:** verify_button_coverage падал из-за неучтённой кнопки из failure UI. **Стало:** failure UI добавлен в сканирование + тест на успешную проверку покрытия. 
- **Webhook + DATABASE_URL:** при webhook режиме отсутствие DATABASE_URL допускало запуск без singleton lock. **Стало:** обязательная валидация конфигурации + защита в runtime; добавлен тест на требование DB и симуляция lock. 
- **Docker stubs:** Dockerfile создавал пустые bot_kie_services/bot_kie_utils. **Стало:** удалены заглушки и добавлен build-guard на stub-модули. 
- **SSOT output_media_type:** допускались voice/file значения и отсутствовала строгая проверка совместимости. **Стало:** введена проверка совместимости и разрешённых типов + нормализация на document/audio. 
- **Back-to-previous UX:** при отсутствии истории шагов бот возвращался к тому же prompt без объяснения. **Стало:** явное сообщение с кодом UX_NO_HISTORY и полезными кнопками. 

**Причина:** устранить P0 регрессии (callback coverage, webhook safety, Docker stubs, SSOT media types, UX навигация).

**Затронутые файлы:**
- `scripts/verify_button_coverage.py`, `scripts/verify_output_media_type.py`, `scripts/verify_project.py`
- `app/config.py`, `app/utils/singleton_lock.py`, `main_render.py`, `app/observability/error_catalog.py`
- `app/kie_catalog/catalog.py`, `app/generations/universal_engine.py`, `app/generations/kie_job_runner.py`
- `bot_kie.py`, `Dockerfile`, `Dockerfile.optimized`
- `tests/test_button_coverage_verification.py`, `tests/test_webhook_db_requirement.py`, `tests/test_navigation_ux.py`
- `tests/test_universal_engine_ssot.py`, `tests/test_all_models_contract.py`, `tests/test_generation_modalities_flow.py`, `tests/test_kie_job_runner_e2e.py`, `tests/test_409_conflict_fix.py`

**Проверка (stdout):**
<details>
<summary><code>python scripts/verify_project.py</code></summary>

```
Listing '.'...
Listing './.cursor'...
Listing './.git'...
Listing './.git/branches'...
Listing './.git/hooks'...
Listing './.git/info'...
Listing './.git/logs'...
Listing './.git/logs/refs'...
Listing './.git/logs/refs/heads'...
Listing './.git/logs/refs/remotes'...
Listing './.git/objects'...
Listing './.git/objects/08'...
Listing './.git/objects/09'...
Listing './.git/objects/14'...
Listing './.git/objects/1f'...
Listing './.git/objects/21'...
Listing './.git/objects/25'...
Listing './.git/objects/26'...
Listing './.git/objects/28'...
Listing './.git/objects/35'...
Listing './.git/objects/36'...
Listing './.git/objects/37'...
Listing './.git/objects/38'...
Listing './.git/objects/42'...
Listing './.git/objects/43'...
Listing './.git/objects/4b'...
Listing './.git/objects/4c'...
Listing './.git/objects/58'...
Listing './.git/objects/5b'...
Listing './.git/objects/5c'...
Listing './.git/objects/60'...
Listing './.git/objects/64'...
Listing './.git/objects/68'...
Listing './.git/objects/6b'...
Listing './.git/objects/6f'...
Listing './.git/objects/70'...
Listing './.git/objects/7e'...
Listing './.git/objects/7f'...
Listing './.git/objects/91'...
Listing './.git/objects/94'...
Listing './.git/objects/a8'...
Listing './.git/objects/ac'...
Listing './.git/objects/af'...
Listing './.git/objects/c2'...
Listing './.git/objects/cb'...
Listing './.git/objects/ce'...
Listing './.git/objects/d6'...
Listing './.git/objects/de'...
Listing './.git/objects/e4'...
Listing './.git/objects/ec'...
Listing './.git/objects/ed'...
Listing './.git/objects/f0'...
Listing './.git/objects/f6'...
Listing './.git/objects/ff'...
Listing './.git/objects/info'...
Listing './.git/objects/pack'...
Listing './.git/refs'...
Listing './.git/refs/heads'...
Listing './.git/refs/remotes'...
Listing './.git/refs/tags'...
Listing './.github'...
Listing './.github/workflows'...
Listing './5656-main'...
Listing './5656-main/app'...
Listing './5656-main/app/database'...
Listing './5656-main/app/locking'...
Listing './5656-main/app/middleware'...
Listing './5656-main/app/observability'...
Listing './5656-main/app/services'...
Listing './5656-main/app/storage'...
Listing './5656-main/app/telemetry'...
Listing './5656-main/app/utils'...
Listing './5656-main/bot'...
Listing './5656-main/bot/handlers'...
Listing './5656-main/bot/middleware'...
Listing './5656-main/models'...
Listing './5656-main/scripts'...
Listing './5656-main/tests'...
Listing './BB_Scanner'...
Listing './BB_Scanner/.runtime'...
Listing './BB_Scanner/.runtime/uv'...
Listing './app'...
Listing './app/buttons'...
Listing './app/delivery'...
Listing './app/domain'...
Listing './app/generations'...
Listing './app/helpers'...
Listing './app/integrations'...
Listing './app/jobs'...
Listing './app/kie'...
Listing './app/kie_catalog'...
Listing './app/kie_contract'...
Listing './app/locking'...
Listing './app/middleware'...
Listing './app/models'...
Listing './app/observability'...
Listing './app/runtime'...
Listing './app/services'...
Listing './app/state'...
Listing './app/storage'...
Listing './app/utils'...
Listing './app/ux'...
Listing './artifacts'...
Listing './artifacts/behavioral'...
Listing './artifacts/buttons'...
Listing './artifacts/diag'...
Listing './artifacts/diagnostics'...
Listing './artifacts/inputs'...
Listing './artifacts/models'...
Listing './artifacts/proof'...
Listing './bot'...
Listing './bot/handlers'...
Listing './data'...
Listing './docs'...
Listing './kie_sync'...
Listing './migrations'...
Listing './models'...
Listing './node_modules'...
Listing './node_modules/.bin'...
Listing './node_modules/@supabase'...
Listing './node_modules/@supabase/auth-js'...
Listing './node_modules/@supabase/auth-js/dist'...
Listing './node_modules/@supabase/auth-js/dist/main'...
Listing './node_modules/@supabase/auth-js/dist/main/lib'...
Listing './node_modules/@supabase/auth-js/dist/main/lib/web3'...
Listing './node_modules/@supabase/auth-js/dist/module'...
Listing './node_modules/@supabase/auth-js/dist/module/lib'...
Listing './node_modules/@supabase/auth-js/dist/module/lib/web3'...
Listing './node_modules/@supabase/auth-js/src'...
Listing './node_modules/@supabase/auth-js/src/lib'...
Listing './node_modules/@supabase/auth-js/src/lib/web3'...
Listing './node_modules/@supabase/functions-js'...
Listing './node_modules/@supabase/functions-js/dist'...
Listing './node_modules/@supabase/functions-js/dist/main'...
Listing './node_modules/@supabase/functions-js/dist/module'...
Listing './node_modules/@supabase/functions-js/src'...
Listing './node_modules/@supabase/postgrest-js'...
Listing './node_modules/@supabase/postgrest-js/dist'...
Listing './node_modules/@supabase/postgrest-js/src'...
Listing './node_modules/@supabase/postgrest-js/src/select-query-parser'...
Listing './node_modules/@supabase/postgrest-js/src/types'...
Listing './node_modules/@supabase/postgrest-js/src/types/common'...
Listing './node_modules/@supabase/realtime-js'...
Listing './node_modules/@supabase/realtime-js/dist'...
Listing './node_modules/@supabase/realtime-js/dist/main'...
Listing './node_modules/@supabase/realtime-js/dist/main/lib'...
Listing './node_modules/@supabase/realtime-js/dist/module'...
Listing './node_modules/@supabase/realtime-js/dist/module/lib'...
Listing './node_modules/@supabase/realtime-js/src'...
Listing './node_modules/@supabase/realtime-js/src/lib'...
Listing './node_modules/@supabase/storage-js'...
Listing './node_modules/@supabase/storage-js/dist'...
Listing './node_modules/@supabase/storage-js/dist/umd'...
Listing './node_modules/@supabase/storage-js/src'...
Listing './node_modules/@supabase/storage-js/src/lib'...
Listing './node_modules/@supabase/storage-js/src/lib/vectors'...
Listing './node_modules/@supabase/storage-js/src/packages'...
Listing './node_modules/@supabase/supabase-js'...
Listing './node_modules/@supabase/supabase-js/dist'...
Listing './node_modules/@supabase/supabase-js/dist/umd'...
Listing './node_modules/@supabase/supabase-js/src'...
Listing './node_modules/@supabase/supabase-js/src/lib'...
Listing './node_modules/@supabase/supabase-js/src/lib/rest'...
Listing './node_modules/@supabase/supabase-js/src/lib/rest/types'...
Listing './node_modules/@supabase/supabase-js/src/lib/rest/types/common'...
Listing './node_modules/@telegraf'...
Listing './node_modules/@telegraf/types'...
Listing './node_modules/@tokenizer'...
Listing './node_modules/@tokenizer/token'...
Listing './node_modules/@types'...
Listing './node_modules/@types/node'...
Listing './node_modules/@types/node/assert'...
Listing './node_modules/@types/node/compatibility'...
Listing './node_modules/@types/node/dns'...
Listing './node_modules/@types/node/fs'...
Listing './node_modules/@types/node/inspector'...
Listing './node_modules/@types/node/path'...
Listing './node_modules/@types/node/readline'...
Listing './node_modules/@types/node/stream'...
Listing './node_modules/@types/node/test'...
Listing './node_modules/@types/node/timers'...
Listing './node_modules/@types/node/ts5.6'...
Listing './node_modules/@types/node/ts5.6/compatibility'...
Listing './node_modules/@types/node/ts5.7'...
Listing './node_modules/@types/node/ts5.7/compatibility'...
Listing './node_modules/@types/node/util'...
Listing './node_modules/@types/node/web-globals'...
Listing './node_modules/@types/phoenix'...
Listing './node_modules/@types/ws'...
Listing './node_modules/abort-controller'...
Listing './node_modules/abort-controller/dist'...
Listing './node_modules/anymatch'...
Listing './node_modules/asynckit'...
Listing './node_modules/asynckit/lib'...
Listing './node_modules/axios'...
Listing './node_modules/axios/dist'...
Listing './node_modules/axios/dist/browser'...
Listing './node_modules/axios/dist/esm'...
Listing './node_modules/axios/dist/node'...
Listing './node_modules/axios/lib'...
Listing './node_modules/axios/lib/adapters'...
Listing './node_modules/axios/lib/cancel'...
Listing './node_modules/axios/lib/core'...
Listing './node_modules/axios/lib/defaults'...
Listing './node_modules/axios/lib/env'...
Listing './node_modules/axios/lib/env/classes'...
Listing './node_modules/axios/lib/helpers'...
Listing './node_modules/axios/lib/platform'...
Listing './node_modules/axios/lib/platform/browser'...
Listing './node_modules/axios/lib/platform/browser/classes'...
Listing './node_modules/axios/lib/platform/common'...
Listing './node_modules/axios/lib/platform/node'...
Listing './node_modules/axios/lib/platform/node/classes'...
Listing './node_modules/balanced-match'...
Listing './node_modules/balanced-match/.github'...
Listing './node_modules/base64-js'...
Listing './node_modules/binary-extensions'...
Listing './node_modules/boolbase'...
Listing './node_modules/brace-expansion'...
Listing './node_modules/braces'...
Listing './node_modules/braces/lib'...
Listing './node_modules/buffer'...
Listing './node_modules/buffer-alloc'...
Listing './node_modules/buffer-alloc-unsafe'...
Listing './node_modules/buffer-fill'...
Listing './node_modules/call-bind-apply-helpers'...
Listing './node_modules/call-bind-apply-helpers/.github'...
Listing './node_modules/call-bind-apply-helpers/test'...
Listing './node_modules/cheerio'...
Listing './node_modules/cheerio/dist'...
Listing './node_modules/cheerio/dist/browser'...
Listing './node_modules/cheerio/dist/browser/api'...
Listing './node_modules/cheerio/dist/browser/parsers'...
Listing './node_modules/cheerio/dist/commonjs'...
Listing './node_modules/cheerio/dist/commonjs/api'...
Listing './node_modules/cheerio/dist/commonjs/parsers'...
Listing './node_modules/cheerio/dist/esm'...
Listing './node_modules/cheerio/dist/esm/api'...
Listing './node_modules/cheerio/dist/esm/parsers'...
Listing './node_modules/cheerio/src'...
Listing './node_modules/cheerio/src/__fixtures__'...
Listing './node_modules/cheerio/src/__tests__'...
Listing './node_modules/cheerio/src/api'...
Listing './node_modules/cheerio/src/parsers'...
Listing './node_modules/cheerio-select'...
Listing './node_modules/cheerio-select/lib'...
Listing './node_modules/cheerio-select/lib/esm'...
Listing './node_modules/chokidar'...
Listing './node_modules/chokidar/lib'...
Listing './node_modules/chokidar/types'...
Listing './node_modules/combined-stream'...
Listing './node_modules/combined-stream/lib'...
Listing './node_modules/concat-map'...
Listing './node_modules/concat-map/example'...
Listing './node_modules/concat-map/test'...
Listing './node_modules/css-select'...
Listing './node_modules/css-select/lib'...
Listing './node_modules/css-select/lib/esm'...
Listing './node_modules/css-select/lib/esm/helpers'...
Listing './node_modules/css-select/lib/esm/pseudo-selectors'...
Listing './node_modules/css-select/lib/helpers'...
Listing './node_modules/css-select/lib/pseudo-selectors'...
Listing './node_modules/css-what'...
Listing './node_modules/css-what/lib'...
Listing './node_modules/css-what/lib/commonjs'...
Listing './node_modules/css-what/lib/es'...
Listing './node_modules/debug'...
Listing './node_modules/debug/src'...
Listing './node_modules/delayed-stream'...
Listing './node_modules/delayed-stream/lib'...
Listing './node_modules/dom-serializer'...
Listing './node_modules/dom-serializer/lib'...
Listing './node_modules/dom-serializer/lib/esm'...
Listing './node_modules/domelementtype'...
Listing './node_modules/domelementtype/lib'...
Listing './node_modules/domelementtype/lib/esm'...
Listing './node_modules/domhandler'...
Listing './node_modules/domhandler/lib'...
Listing './node_modules/domhandler/lib/esm'...
Listing './node_modules/domutils'...
Listing './node_modules/domutils/lib'...
Listing './node_modules/domutils/lib/esm'...
Listing './node_modules/dotenv'...
Listing './node_modules/dotenv/lib'...
Listing './node_modules/dunder-proto'...
Listing './node_modules/dunder-proto/.github'...
Listing './node_modules/dunder-proto/test'...
Listing './node_modules/encoding-sniffer'...
Listing './node_modules/encoding-sniffer/dist'...
Listing './node_modules/encoding-sniffer/dist/commonjs'...
Listing './node_modules/encoding-sniffer/dist/esm'...
Listing './node_modules/entities'...
Listing './node_modules/entities/lib'...
Listing './node_modules/entities/lib/esm'...
Listing './node_modules/entities/lib/esm/generated'...
Listing './node_modules/entities/lib/generated'...
Listing './node_modules/es-define-property'...
Listing './node_modules/es-define-property/.github'...
Listing './node_modules/es-define-property/test'...
Listing './node_modules/es-errors'...
Listing './node_modules/es-errors/.github'...
Listing './node_modules/es-errors/test'...
Listing './node_modules/es-object-atoms'...
Listing './node_modules/es-object-atoms/.github'...
Listing './node_modules/es-object-atoms/test'...
Listing './node_modules/es-set-tostringtag'...
Listing './node_modules/es-set-tostringtag/test'...
Listing './node_modules/event-target-shim'...
Listing './node_modules/event-target-shim/dist'...
Listing './node_modules/events'...
Listing './node_modules/events/.github'...
Listing './node_modules/events/tests'...
Listing './node_modules/file-type'...
Listing './node_modules/fill-range'...
Listing './node_modules/follow-redirects'...
Listing './node_modules/form-data'...
Listing './node_modules/form-data/lib'...
Listing './node_modules/fs-extra'...
Listing './node_modules/fs-extra/lib'...
Listing './node_modules/fs-extra/lib/copy'...
Listing './node_modules/fs-extra/lib/empty'...
Listing './node_modules/fs-extra/lib/ensure'...
Listing './node_modules/fs-extra/lib/fs'...
Listing './node_modules/fs-extra/lib/json'...
Listing './node_modules/fs-extra/lib/mkdirs'...
Listing './node_modules/fs-extra/lib/move'...
Listing './node_modules/fs-extra/lib/output-file'...
Listing './node_modules/fs-extra/lib/path-exists'...
Listing './node_modules/fs-extra/lib/remove'...
Listing './node_modules/fs-extra/lib/util'...
Listing './node_modules/function-bind'...
Listing './node_modules/function-bind/.github'...
Listing './node_modules/function-bind/test'...
Listing './node_modules/get-intrinsic'...
Listing './node_modules/get-intrinsic/.github'...
Listing './node_modules/get-intrinsic/test'...
Listing './node_modules/get-proto'...
Listing './node_modules/get-proto/.github'...
Listing './node_modules/get-proto/test'...
Listing './node_modules/glob-parent'...
Listing './node_modules/gopd'...
Listing './node_modules/gopd/.github'...
Listing './node_modules/gopd/test'...
Listing './node_modules/graceful-fs'...
Listing './node_modules/has-flag'...
Listing './node_modules/has-symbols'...
Listing './node_modules/has-symbols/.github'...
Listing './node_modules/has-symbols/test'...
Listing './node_modules/has-symbols/test/shams'...
Listing './node_modules/has-tostringtag'...
Listing './node_modules/has-tostringtag/.github'...
Listing './node_modules/has-tostringtag/test'...
Listing './node_modules/has-tostringtag/test/shams'...
Listing './node_modules/hasown'...
Listing './node_modules/hasown/.github'...
Listing './node_modules/he'...
Listing './node_modules/he/bin'...
Listing './node_modules/he/man'...
Listing './node_modules/htmlparser2'...
Listing './node_modules/htmlparser2/dist'...
Listing './node_modules/htmlparser2/dist/commonjs'...
Listing './node_modules/htmlparser2/dist/esm'...
Listing './node_modules/htmlparser2/node_modules'...
Listing './node_modules/htmlparser2/node_modules/entities'...
Listing './node_modules/htmlparser2/node_modules/entities/dist'...
Listing './node_modules/htmlparser2/node_modules/entities/dist/commonjs'...
Listing './node_modules/htmlparser2/node_modules/entities/dist/commonjs/generated'...
Listing './node_modules/htmlparser2/node_modules/entities/dist/esm'...
Listing './node_modules/htmlparser2/node_modules/entities/dist/esm/generated'...
Listing './node_modules/htmlparser2/node_modules/entities/src'...
Listing './node_modules/htmlparser2/node_modules/entities/src/generated'...
Listing './node_modules/htmlparser2/src'...
Listing './node_modules/htmlparser2/src/__fixtures__'...
Listing './node_modules/htmlparser2/src/__fixtures__/Documents'...
Listing './node_modules/htmlparser2/src/__snapshots__'...
Listing './node_modules/iceberg-js'...
Listing './node_modules/iceberg-js/dist'...
Listing './node_modules/iconv-lite'...
Listing './node_modules/iconv-lite/.github'...
Listing './node_modules/iconv-lite/.idea'...
Listing './node_modules/iconv-lite/.idea/codeStyles'...
Listing './node_modules/iconv-lite/.idea/inspectionProfiles'...
Listing './node_modules/iconv-lite/encodings'...
Listing './node_modules/iconv-lite/encodings/tables'...
Listing './node_modules/iconv-lite/lib'...
Listing './node_modules/ieee754'...
Listing './node_modules/ignore-by-default'...
Listing './node_modules/is-binary-path'...
Listing './node_modules/is-extglob'...
Listing './node_modules/is-glob'...
Listing './node_modules/is-number'...
Listing './node_modules/jsonfile'...
Listing './node_modules/math-intrinsics'...
Listing './node_modules/math-intrinsics/.github'...
Listing './node_modules/math-intrinsics/constants'...
Listing './node_modules/math-intrinsics/test'...
Listing './node_modules/mime-db'...
Listing './node_modules/mime-types'...
Listing './node_modules/minimatch'...
Listing './node_modules/mri'...
Listing './node_modules/mri/lib'...
Listing './node_modules/ms'...
Listing './node_modules/node-fetch'...
Listing './node_modules/node-fetch/lib'...
Listing './node_modules/node-html-parser'...
Listing './node_modules/node-html-parser/dist'...
Listing './node_modules/node-html-parser/dist/nodes'...
Listing './node_modules/nodemon'...
Listing './node_modules/nodemon/bin'...
Listing './node_modules/nodemon/doc'...
Listing './node_modules/nodemon/doc/cli'...
Listing './node_modules/nodemon/lib'...
Listing './node_modules/nodemon/lib/cli'...
Listing './node_modules/nodemon/lib/config'...
Listing './node_modules/nodemon/lib/help'...
Listing './node_modules/nodemon/lib/monitor'...
Listing './node_modules/nodemon/lib/rules'...
Listing './node_modules/nodemon/lib/utils'...
Listing './node_modules/normalize-path'...
Listing './node_modules/nth-check'...
Listing './node_modules/nth-check/lib'...
Listing './node_modules/nth-check/lib/esm'...
Listing './node_modules/p-timeout'...
Listing './node_modules/parse5'...
Listing './node_modules/parse5/dist'...
Listing './node_modules/parse5/dist/cjs'...
Listing './node_modules/parse5/dist/cjs/common'...
Listing './node_modules/parse5/dist/cjs/parser'...
Listing './node_modules/parse5/dist/cjs/serializer'...
Listing './node_modules/parse5/dist/cjs/tokenizer'...
Listing './node_modules/parse5/dist/cjs/tree-adapters'...
Listing './node_modules/parse5/dist/common'...
Listing './node_modules/parse5/dist/parser'...
Listing './node_modules/parse5/dist/serializer'...
Listing './node_modules/parse5/dist/tokenizer'...
Listing './node_modules/parse5/dist/tree-adapters'...
Listing './node_modules/parse5/node_modules'...
Listing './node_modules/parse5/node_modules/entities'...
Listing './node_modules/parse5/node_modules/entities/dist'...
Listing './node_modules/parse5/node_modules/entities/dist/commonjs'...
Listing './node_modules/parse5/node_modules/entities/dist/commonjs/generated'...
Listing './node_modules/parse5/node_modules/entities/dist/esm'...
Listing './node_modules/parse5/node_modules/entities/dist/esm/generated'...
Listing './node_modules/parse5/node_modules/entities/src'...
Listing './node_modules/parse5/node_modules/entities/src/generated'...
Listing './node_modules/parse5-htmlparser2-tree-adapter'...
Listing './node_modules/parse5-htmlparser2-tree-adapter/dist'...
Listing './node_modules/parse5-htmlparser2-tree-adapter/dist/cjs'...
Listing './node_modules/parse5-parser-stream'...
Listing './node_modules/parse5-parser-stream/dist'...
Listing './node_modules/parse5-parser-stream/dist/cjs'...
Listing './node_modules/peek-readable'...
Listing './node_modules/peek-readable/lib'...
Listing './node_modules/picomatch'...
Listing './node_modules/picomatch/lib'...
Listing './node_modules/process'...
Listing './node_modules/proxy-from-env'...
Listing './node_modules/pstree.remy'...
Listing './node_modules/pstree.remy/lib'...
Listing './node_modules/pstree.remy/tests'...
Listing './node_modules/pstree.remy/tests/fixtures'...
Listing './node_modules/readable-stream'...
Listing './node_modules/readable-stream/lib'...
Listing './node_modules/readable-stream/lib/internal'...
Listing './node_modules/readable-stream/lib/internal/streams'...
Listing './node_modules/readable-stream/lib/ours'...
Listing './node_modules/readable-stream/lib/ours/util'...
Listing './node_modules/readable-stream/lib/stream'...
Listing './node_modules/readable-web-to-node-stream'...
Listing './node_modules/readable-web-to-node-stream/lib'...
Listing './node_modules/readdirp'...
Listing './node_modules/safe-buffer'...
Listing './node_modules/safe-compare'...
Listing './node_modules/safer-buffer'...
Listing './node_modules/sandwich-stream'...
Listing './node_modules/sandwich-stream/dist'...
Listing './node_modules/semver'...
Listing './node_modules/semver/bin'...
Listing './node_modules/semver/classes'...
Listing './node_modules/semver/functions'...
Listing './node_modules/semver/internal'...
Listing './node_modules/semver/ranges'...
Listing './node_modules/simple-update-notifier'...
Listing './node_modules/simple-update-notifier/build'...
Listing './node_modules/simple-update-notifier/src'...
Listing './node_modules/string_decoder'...
Listing './node_modules/string_decoder/lib'...
Listing './node_modules/strtok3'...
Listing './node_modules/strtok3/lib'...
Listing './node_modules/supports-color'...
Listing './node_modules/telegraf'...
Listing './node_modules/telegraf/lib'...
Listing './node_modules/telegraf/lib/core'...
Listing './node_modules/telegraf/lib/core/helpers'...
Listing './node_modules/telegraf/lib/core/network'...
Listing './node_modules/telegraf/lib/core/types'...
Listing './node_modules/telegraf/lib/scenes'...
Listing './node_modules/telegraf/lib/scenes/wizard'...
Listing './node_modules/telegraf/src'...
Listing './node_modules/telegraf/src/core'...
Listing './node_modules/telegraf/src/core/helpers'...
Listing './node_modules/telegraf/src/core/network'...
Listing './node_modules/telegraf/src/core/types'...
Listing './node_modules/telegraf/src/scenes'...
Listing './node_modules/telegraf/src/scenes/wizard'...
Listing './node_modules/telegraf/typings'...
Listing './node_modules/telegraf/typings/core'...
Listing './node_modules/telegraf/typings/core/helpers'...
Listing './node_modules/telegraf/typings/core/network'...
Listing './node_modules/telegraf/typings/core/types'...
Listing './node_modules/telegraf/typings/scenes'...
Listing './node_modules/telegraf/typings/scenes/wizard'...
Listing './node_modules/to-regex-range'...
Listing './node_modules/token-types'...
Listing './node_modules/token-types/lib'...
Listing './node_modules/touch'...
Listing './node_modules/touch/bin'...
Listing './node_modules/tr46'...
Listing './node_modules/tr46/lib'...
Listing './node_modules/tslib'...
Listing './node_modules/tslib/modules'...
Listing './node_modules/undefsafe'...
Listing './node_modules/undefsafe/.github'...
Listing './node_modules/undefsafe/.github/workflows'...
Listing './node_modules/undefsafe/lib'...
Listing './node_modules/undici'...
Listing './node_modules/undici/docs'...
Listing './node_modules/undici/docs/docs'...
Listing './node_modules/undici/docs/docs/api'...
Listing './node_modules/undici/docs/docs/best-practices'...
Listing './node_modules/undici/lib'...
Listing './node_modules/undici/lib/api'...
Listing './node_modules/undici/lib/cache'...
Listing './node_modules/undici/lib/core'...
Listing './node_modules/undici/lib/dispatcher'...
Listing './node_modules/undici/lib/encoding'...
Listing './node_modules/undici/lib/handler'...
Listing './node_modules/undici/lib/interceptor'...
Listing './node_modules/undici/lib/llhttp'...
Listing './node_modules/undici/lib/mock'...
Listing './node_modules/undici/lib/util'...
Listing './node_modules/undici/lib/web'...
Listing './node_modules/undici/lib/web/cache'...
Listing './node_modules/undici/lib/web/cookies'...
Listing './node_modules/undici/lib/web/eventsource'...
Listing './node_modules/undici/lib/web/fetch'...
Listing './node_modules/undici/lib/web/infra'...
Listing './node_modules/undici/lib/web/subresource-integrity'...
Listing './node_modules/undici/lib/web/webidl'...
Listing './node_modules/undici/lib/web/websocket'...
Listing './node_modules/undici/lib/web/websocket/stream'...
Listing './node_modules/undici/scripts'...
Listing './node_modules/undici/types'...
Listing './node_modules/undici-types'...
Listing './node_modules/universalify'...
Listing './node_modules/validator'...
Listing './node_modules/validator/es'...
Listing './node_modules/validator/es/lib'...
Listing './node_modules/validator/es/lib/util'...
Listing './node_modules/validator/lib'...
Listing './node_modules/validator/lib/util'...
Listing './node_modules/webidl-conversions'...
Listing './node_modules/webidl-conversions/lib'...
Listing './node_modules/whatwg-encoding'...
Listing './node_modules/whatwg-encoding/lib'...
Listing './node_modules/whatwg-mimetype'...
Listing './node_modules/whatwg-mimetype/lib'...
Listing './node_modules/whatwg-url'...
Listing './node_modules/whatwg-url/lib'...
Listing './node_modules/ws'...
Listing './node_modules/ws/lib'...
Listing './pricing'...
Listing './scripts'...
Listing './storage'...
Listing './storage/partner-01'...
Listing './tests'...
Listing './tests/fakes'...
Listing './tests/fixtures'...
Listing './tests/ux'...
Listing './tools'...
Listing './tools/kie_sync'...
Listing './все'...
Listing './все/Новая папка'...
============================= test session starts ==============================
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0
rootdir: /workspace/TRT
configfile: pytest.ini
testpaths: tests
plugins: asyncio-1.3.0, anyio-4.12.1
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 330 items

tests/test_409_conflict_fix.py ........✅ SSOT verification passed: registry=72 pricing=72 free=1 meta_total=72
⚠️ output_media_type warnings:
- z-image: output_media_type missing, resolved to image
- nano-banana-pro: output_media_type missing, resolved to image
- seedream/4.5-text-to-image: output_media_type missing, resolved to image
- seedream/4.5-edit: output_media_type missing, resolved to image
- sora-2-pro-image-to-video: output_media_type missing, resolved to video
- sora-watermark-remover: output_media_type missing, resolved to image
- sora-2-text-to-video: output_media_type missing, resolved to video
- kling-2.6/image-to-video: output_media_type missing, resolved to video
- kling-2.6/text-to-video: output_media_type missing, resolved to video
- flux-2/pro-image-to-image: output_media_type missing, resolved to image
- flux-2/pro-text-to-image: output_media_type missing, resolved to image
- flux-2/flex-image-to-image: output_media_type missing, resolved to image
- flux-2/flex-text-to-image: output_media_type missing, resolved to image
- topaz/image-upscale: output_media_type missing, resolved to image
- kling/v2-5-turbo-text-to-video-pro: output_media_type missing, resolved to video
- kling/v2-5-turbo-image-to-video-pro: output_media_type missing, resolved to video
- wan/2-5-image-to-video: output_media_type missing, resolved to video
- wan/2-5-text-to-video: output_media_type missing, resolved to video
- wan/2-2-animate-move: output_media_type missing, resolved to image
- wan/2-2-animate-replace: output_media_type missing, resolved to image
... and 52 more
✅ output_media_type validated for 72 models
✅ No placeholder markers in runtime import graph
✅ Button coverage OK: 77 callbacks covered
✅ KIE single entrypoint verified
⚠️ SSOT consistency warnings:
- nano-banana-pro: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- seedream/4.5-edit: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_urls)
- sora-watermark-remover: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (video_url)
- wan/2-2-animate-move: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (video_input, image_input)
- wan/2-2-animate-replace: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (video_input, image_input)
- kling/v1-avatar-standard: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input, audio_input)
- kling/ai-avatar-v1-pro: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input, audio_input)
- bytedance/seedream-v4-edit: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- recraft/crisp-upscale: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- ideogram/character-edit: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input, mask_input, reference_image_input)
- ideogram/character-remix: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input, reference_image_input)
- ideogram/character: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (reference_image_input)
- kling/v2-1-standard: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- kling/v2-1-pro: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- ideogram/v3-edit: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input, mask_input)
- ideogram/v3-remix: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_input)
- google/nano-banana-edit: SSOT_CONFLICT_TEXT_MODEL_REQUIRES_IMAGE (image_urls)
✅ Model specs verified for 72 models
✅ Registry present: 72 models
ℹ️ Runtime SSOT is root /models + /app. 5656-main is deprecated/ignored.
⚠️ Legacy 5656-main registry differs from root /models (SSOT)
ℹ️ Runtime SSOT: root /models + /app. Folder 5656-main is deprecated/ignored.

$ python -m compileall .

$ pytest -q

$ python scripts/verify_ssot.py

$ python scripts/verify_output_media_type.py

$ python scripts/verify_no_placeholders.py

$ python scripts/verify_button_coverage.py

$ python scripts/verify_kie_single_entrypoint.py

$ python scripts/verify_model_specs.py

$ python scripts/verify_source_of_truth.py

$ rg -n "BEGIN PRIVATE KEY|AKIA[0-9A-Z]{16}" -g '!node_modules' -g '!.git' -g '!scripts/verify_project.py'
✅ No secrets detected.

✅ No zero-byte files detected.

```
</details>

<details>
<summary><code>pytest -q</code></summary>

```
============================= test session starts ==============================
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0
rootdir: /workspace/TRT
configfile: pytest.ini
testpaths: tests
plugins: asyncio-1.3.0, anyio-4.12.1
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 330 items

tests/test_409_conflict_fix.py ........
```
</details>

<details>
<summary><code>python scripts/verify_button_coverage.py</code></summary>

```
✅ Button coverage OK: 77 callbacks covered

```
</details>

**Статус:** ✅ verify_project/pytest/verify_button_coverage зелёные.

---
## 2026-02-04: P0/P1 — pricing transparency, multi-mode selection, universal engine UX
**Было → стало (ключевые изменения):**
- **P0 (price preview):** перед генерацией не было прозрачного экрана стоимости/баланса и правил округления. **Стало:** перед стартом платных моделей показывается стоимость (ceil ₽), баланс и остаток + кнопки действий при нехватке. 【F:bot_kie.py†L1120-L1215】【F:bot_kie.py†L14260-L14278】
- **P0 (multi‑mode):** режимы моделей не выбирались, по умолчанию использовался mode_index=0, что ломало цену/списание. **Стало:** при нескольких режимах показывается выбор с сохранением mode_index в сессии, цены считают выбранный режим. 【F:bot_kie.py†L1036-L1063】【F:bot_kie.py†L9711-L9730】
- **P0 (унификация генерации):** часть сценариев шла через legacy gateway. **Стало:** confirm_generate и автозапуск используют universal_engine, а 401/402/422/429/500 маппятся в понятные сообщения. 【F:app/generations/universal_engine.py†L61-L78】【F:bot_kie.py†L14362-L14598】
- **P0 (seedream contract):** отсутствовал контрактный тест под bytedance/seedream. **Стало:** тест на payload и разбор resultUrls в recordInfo. 【F:tests/test_seedream_contract.py†L1-L33】
- **P1 (main menu copy):** приветствие не содержало 70+ моделей/5 в час/рубли/округление. **Стало:** обновлено RU/EN приветствие с явным правилом округления. 【F:translations.py†L8-L20】【F:translations.py†L279-L292】
- **P1 (mode flow test):** не было проверки выбора режима → цены → списания → запуска. **Стало:** добавлен тест с multi‑mode моделью. 【F:tests/test_mode_selection_flow.py†L1-L113】

**Файлы изменены (основные):**
- `bot_kie.py`, `app/generations/universal_engine.py`, `translations.py`
- `tests/test_seedream_contract.py`, `tests/test_mode_selection_flow.py`

**Команды проверки:**
- `pytest -q`

## 2026-02-03: P0/P1 hardening — trace outcome fix, image_edit adapter, throttling, upload resilience
**Было → стало (ключевые изменения):**
- **P0 (outgoing crash):** `track_outgoing_action` мог падать на двойном `outcome` в `trace_event`. **Стало:** `outcome` исключён из распаковки контекста + тест на безопасный вызов. 【F:app/observability/no_silence_guard.py†L63-L92】【F:tests/test_no_silence_guard_trace_context.py†L1-L32】
- **P0 (image_edit 422):** `image_input` не конвертировался в KIE‑ожидаемое поле при SSOT→payload в `universal_engine`. **Стало:** добавлен строгий адаптер `image_input → image/image_url`, покрыт тестом для `recraft/remove-background`. 【F:app/kie_contract/image_adapter.py†L1-L38】【F:app/kie_contract/payload_builder.py†L1-L45】【F:kie_input_adapter.py†L186-L209】【F:tests/test_kie_payload_image_edit.py†L1-L12】
- **P1 (anti‑spam):** не было централизованного throttle/dedup для обновлений/коллбеков. **Стало:** token‑bucket лимит на сообщения/коллбеки + TTL‑dedup по `update_id` и `callback_query.id` с UX “Too fast…” и кнопкой главного меню. 【F:app/middleware/rate_limit.py†L1-L68】【F:tests/test_rate_limit_and_dedup.py†L1-L27】【F:bot_kie.py†L96-L214】
- **P1 (submit lock):** повторный `confirm_generate` мог запускать дубль до регистрации task_id. **Стало:** введён submit‑lock с TTL и UX‑ответом. 【F:bot_kie.py†L914-L1006】【F:bot_kie.py†L13560-L13637】
- **P1 (upload reliability):** 0x0.st часто давал 403 из‑за отсутствия UA; таймауты и fallback логировались неявно. **Стало:** добавлен User‑Agent, настроены таймауты, усилено логирование провайдера/фолбэка. 【F:bot_kie.py†L2772-L3062】
- **P1 (UX resilience):** не было безопасного сброса “мастера” с гарантированным выходом в меню. **Стало:** добавлена команда `/reset` и “reset_wizard” callback, полный сброс сессии при stale‑state. 【F:bot_kie.py†L3396-L3469】【F:bot_kie.py†L1427-L1476】【F:bot_kie.py†L3812-L3872】【F:bot_kie.py†L27306-L28386】

**Root cause:**
- Дублирующееся `outcome` попадало в `trace_event` через `trace_ctx`, ломая outgoing‑логирование.
- SSOT‑payload builder не маппировал `image_input` в фактическое поле KIE для image‑edit моделей.
- Отсутствовала единая защита от спама/повторов на входе и rate‑limit для callback‑сессий.
- В upload fallback отсутствовал корректный UA и строгие таймауты.

**Файлы изменены (основные):**
- `app/observability/no_silence_guard.py`, `app/kie_contract/image_adapter.py`, `app/kie_contract/payload_builder.py`, `kie_input_adapter.py`
- `app/middleware/rate_limit.py`, `bot_kie.py`
- `tests/test_no_silence_guard_trace_context.py`, `tests/test_kie_payload_image_edit.py`, `tests/test_rate_limit_and_dedup.py`

**Команды проверки:**
- `pytest`

**Оставшиеся риски:**
- Rate‑limit/дедуп хранятся в памяти процесса и сбрасываются при рестарте; для полной устойчивости нужна shared‑store версия.
- Внешние хостинги всё ещё используются как временный обход, до полного перехода на KIE File Upload API.

## 2026-02-02: P0 hardening — TG delivery, wizard conflicts, observability, free counter, SSOT guardrails
**Было → стало (ключевые изменения):**
- **A (Telegram delivery):** URL‑direct отправка могла приводить к `Wrong type of the web page content` и тихим сбоям. **Стало:** всегда скачиваем медиа через GET, определяем content‑type/подпись по байтам, отбрасываем HTML‑страницы с `KIE_MEDIA_URL_NOT_MEDIA`, выбираем корректный TG метод (включая GIF→animation) и шлём понятный текст при неудаче. 【F:app/generations/media_pipeline.py†L1-L328】【F:app/generations/telegram_sender.py†L1-L311】
- **B (Wizard consistency):** противоречивые модели могли требовать картинку в text‑flow. **Стало:** фиксируется SSOT‑конфликт, prompt остаётся первым, появляется реф‑картинка «Да/Нет», обязательность медиа снимается в wizard и есть recoverable‑flow при ошибке KIE. 【F:bot_kie.py†L470-L1133】【F:bot_kie.py†L10182-L12461】【F:scripts/verify_model_specs.py†L1-L71】
- **C (Tests for all 72 models + delivery):** добавлены контракты на wizard‑старт/параметры по всем моделям и медиапайплайн/telegram‑delivery кейсы (image/video/html/redirect), плюс free‑counter таймеры. 【F:tests/test_wizard_all_models.py†L1-L24】【F:tests/test_media_pipeline.py†L1-L90】【F:tests/test_telegram_sender_media.py†L1-L112】【F:tests/test_free_counter_snapshot.py†L1-L38】【F:tests/test_free_counter_view.py†L1-L33】
- **D (Observability + no‑silence):** каждая UX‑кнопка, KIE create/poll и TG send теперь логируются с correlation_id/error_code/fix_hint; добавлен watchdog‑апдейт прогресса в polling. 【F:bot_kie.py†L3683-L3876】【F:bot_kie.py†L13372-L13943】【F:app/kie/kie_client.py†L260-L396】【F:app/generations/telegram_sender.py†L1-L311】
- **E (SSOT guardrails):** отчёт о том, что SSOT — root /models + /app; добавлено предупреждение, если 5656‑main расходится. 【F:scripts/verify_project.py†L39-L65】【F:scripts/verify_source_of_truth.py†L1-L46】
- **F (Free counter UX):** добавлен расчёт remaining/next_refill_in и вывод строки счётчика на меню/списках/подтверждении/результате‑ошибке с логом FREE_COUNTER_VIEW. 【F:app/services/free_tools_service.py†L40-L92】【F:bot_kie.py†L1600-L1845】【F:app/generations/telegram_sender.py†L230-L319】

**Тесты/проверки:**
- `python scripts/verify_project.py`
- `pytest -q`

# TRT_REPORT.md

## 2026-02-01: Observability + pricing rounding + free menu + generation progress
**Было → стало (ключевые изменения):**
- **Было:** входящие апдейты Telegram иногда не логировались, update_id/user_id/chat_id пропадали в structured logs. **Стало:** контекстные contextvars + middleware для TG_UPDATE_IN и автоподстановка полей в structured logs/trace. 【F:app/observability/context.py†L1-L67】【F:app/observability/structured_logs.py†L20-L58】【F:app/observability/trace.py†L78-L190】【F:bot_kie.py†L113-L178】【F:bot_kie.py†L26084-L27020】
- **Было:** /start мог «молчать» при ошибке. **Стало:** try/except с логом ERR_TG_START_HANDLER и гарантированным ответом пользователю. 【F:bot_kie.py†L3241-L3279】
- **Было:** free tools брались статически и включали аудио. **Стало:** 5 самых дешёвых non‑audio из каталога (детерминированно), с логированием исключений. 【F:app/kie_catalog/catalog.py†L260-L343】【F:app/services/free_tools_service.py†L16-L44】【F:pricing/config.yaml†L23-L31】
- **Было:** цены/балансы показывались с копейками, курс плавал, admin multiplier не фиксирован. **Стало:** курс 77.83 из config, ceil до целого ₽, admin multiplier=1.0. 【F:pricing/config.yaml†L17-L31】【F:pricing/engine.py†L20-L102】【F:app/services/pricing_service.py†L11-L116】【F:bot_kie.py†L820-L960】
- **Было:** долгий KIE_POLL без прогресса/таймаута. **Стало:** прогресс‑апдейты каждые ~25с + таймауты по категориям (image/video/audio) с ERR_KIE_TIMEOUT. 【F:app/generations/universal_engine.py†L220-L392】【F:bot_kie.py†L13210-L13456】

**Файлы изменены (основные):**
- `app/observability/context.py`, `app/observability/structured_logs.py`, `app/observability/trace.py`, `app/observability/error_catalog.py`
- `bot_kie.py`, `helpers.py`, `app/helpers/models_menu.py`, `app/generations/telegram_sender.py`
- `app/kie_catalog/catalog.py`, `app/services/free_tools_service.py`, `app/services/pricing_service.py`, `pricing/config.yaml`, `pricing/config.json`, `pricing/engine.py`
- `tests/test_pricing_rounding.py`, `tests/test_pricing_sources.py`, `tests/test_free_tools_menu.py`, `tests/test_all_models_contract.py`, `tests/test_main_menu.py`

**Тесты/проверки:**
- `python scripts/verify_project.py`
- `pytest -q`

**TOP‑5 “WHAT’S MISSING TO PROD” (P2 only):**
1. **P2:** Telegram fallback send_document всё ещё best‑effort без ретраев, возможны единичные не‑доставки при плохой сети. Evidence: `telegram_sender.deliver_result` fallback catch‑all. 【F:app/generations/telegram_sender.py†L73-L214】 (Fix: not implemented yet.)
2. **P2:** Таймауты пока по категориям, без индивидуальных overrides на модели с >420с. Evidence: `get_generation_timeout_seconds`. 【F:bot_kie.py†L988-L1005】 (Fix: not implemented yet.)
3. **P2:** OCR‑распознавание платежей остаётся эвристикой (может ошибаться на нестандартных скриншотах). Evidence: `analyze_payment_screenshot`. 【F:bot_kie.py†L2472-L2665】 (Fix: not implemented yet.)
4. **P2:** Нет централизованных ретраев для TG_SEND в случае временных ошибок API. Evidence: `telegram_sender.deliver_result`. 【F:app/generations/telegram_sender.py†L73-L214】 (Fix: not implemented yet.)
5. **P2:** Нет пер‑модельного SLA/alert на превышение KIE_POLL по статистике. Evidence: only structured logs emitted. 【F:app/generations/universal_engine.py†L220-L392】 (Fix: not implemented yet.)

## 2026-01-19: P0/P1 production hardening — media delivery, free tools, pricing, modality contract
**Было → стало (ключевые изменения):**
- **Было:** Telegram получал прямые URL и падал на HTML/403/redirect. **Стало:** медиа всегда скачивается сервером, проверяется content-type/size и отправляется как InputFile; для oversized — безопасная ссылка без preview. 【F:app/generations/media_pipeline.py†L1-L278】【F:app/generations/telegram_sender.py†L1-L180】
- **Было:** Wizard иногда просил фото в text→image и смешивал модальности. **Стало:** введён `model_mode`, авто-нормализация required для image/text и корректный первичный ввод; Nano Banana Pro выведен из text→image. 【F:models/kie_models.yaml†L1-L2170】【F:app/models/yaml_registry.py†L1-L167】【F:bot_kie.py†L313-L452】【F:kie_models.py†L2736-L2837】
- **Было:** цены округлялись до int и минимум 1 ₽. **Стало:** фикс курс 77.83, маржа x2, ceil до 0.01 без min=1. 【F:pricing/config.yaml†L1-L42】【F:app/config.py†L79-L141】【F:app/services/pricing_service.py†L1-L102】
- **Было:** free tools “плавающие” и смешивались с категориями. **Стало:** 5 самых дешёвых моделей фиксированы в pricing config, исключены из остальных категорий; лимит 5/час + referral банк. 【F:pricing/config.yaml†L1-L42】【F:app/services/free_tools_service.py†L1-L120】【F:bot_kie.py†L1532-L5166】【F:kie_models.py†L2736-L2837】
- **Было:** кнопка “Баланс” шумела 404. **Стало:** 404 кэшируется на 6 часов, UX “KIE недоступен” без ошибок. 【F:helpers.py†L96-L220】
- **Было:** базовый smoke зависел от GitHub storage env. **Стало:** run_smoke использует JSON storage по умолчанию. 【F:scripts/run_smoke.py†L14-L110】

**Тесты/проверки:**
- `python scripts/verify_project.py`
- `pytest -q`
- `python -m compileall .`
- `python scripts/run_smoke.py`

## 2026-01-19: Production gate + universal media delivery + credits + session lifecycle + offline smoke
**Root cause mapping (лог-инциденты → фиксы):**
- `telegram.error.BadRequest: Wrong type of the web page content` → введён универсальный бинарный media pipeline c проверкой content-type, KIE download-url и fallback на InputFile.【F:app/generations/media_pipeline.py†L1-L250】
- `KIE credits endpoint 404 (/api/v1/account/balance)` → фикс на `/api/v1/chat/credit` + UX “KIE credits temporarily unavailable”.【F:app/kie/kie_client.py†L479-L597】【F:helpers.py†L124-L176】
- `aiohttp Unclosed client session/connector` → единый KIE ClientSession, закрытие в post_shutdown и тест-leak guard.【F:app/bootstrap.py†L82-L151】【F:tests/test_aiohttp_leak_check.py†L1-L19】
- `GEN_ERROR KIE_FAIL_STATE` → редактирование recordInfo (redaction) + чистый UX с retry + структурные логи.【F:app/observability/redaction.py†L1-L35】【F:app/generations/failure_ui.py†L1-L18】【F:bot_kie.py†L13257-L13313】
- `DATABASE_URL not set - skipping singleton lock` → детерминированная конкуренция через GitHub SHA-retry + per-user lock в балансах (no lost updates).【F:app/storage/github_storage.py†L240-L360】【F:app/services/user_service.py†L12-L48】

**Было → стало (ключевые изменения):**
- **Было:** Telegram получал URL, возвращающий HTML/JSON. **Стало:** resolve_and_prepare_telegram_payload проверяет content-type и всегда отдаёт бинарный InputFile/документ при HTML/unknown. 【F:app/generations/media_pipeline.py†L1-L250】
- **Было:** KIE credits шёл на неактуальный endpoint и падал 404. **Стало:** `/api/v1/chat/credit` + UX “KIE credits temporarily unavailable” при сбое. 【F:app/kie/kie_client.py†L479-L597】【F:helpers.py†L124-L214】
- **Было:** aiohttp сессии не закрывались. **Стало:** единый KIE client + close() на shutdown и leak-тест. 【F:app/bootstrap.py†L82-L151】【F:tests/test_kie_client_lifecycle.py†L1-L25】
- **Было:** KIE fail state отдавал сырые детали без UX. **Стало:** редактированные логи + кнопка Retry + чистый текст с correlation_id. 【F:app/observability/redaction.py†L1-L35】【F:app/generations/failure_ui.py†L1-L18】【F:bot_kie.py†L13257-L13313】
- **Было:** риск конфликтов без DB lock. **Стало:** per-user lock в user_service + GitHub sha retry. 【F:app/services/user_service.py†L12-L48】【F:app/storage/github_storage.py†L240-L360】
- **Было:** отсутствовал универсальный release gate. **Стало:** scripts/production_gate.py + offline smoke всех 72 моделей. 【F:scripts/production_gate.py†L1-L44】【F:scripts/smoke_all_models_offline.py†L1-L170】

**Файлы изменены (основные):**
- `app/generations/media_pipeline.py`, `app/generations/telegram_sender.py`, `app/generations/failure_ui.py`
- `app/kie/kie_client.py`, `app/bootstrap.py`, `app/services/user_service.py`, `app/observability/redaction.py`
- `app/generations/universal_engine.py`, `app/generations/kie_job_runner.py`, `bot_kie.py`, `helpers.py`
- `scripts/production_gate.py`, `scripts/smoke_all_models_offline.py`
- `tests/test_media_pipeline.py`, `tests/test_telegram_sender_media.py`, `tests/test_kie_credits.py`, `tests/test_kie_fail_state.py`, `tests/test_aiohttp_leak_check.py`, `tests/test_user_balance_lock.py`, `tests/test_kie_client_lifecycle.py`, `tests/test_recordinfo_redaction.py`

**Команды проверки (выполнены):**
- `python scripts/verify_project.py` → OK
- `pytest -q` → OK
- `python scripts/production_gate.py` → OK

## 2026-01-19: P0/P1 hardening — webhook, KIE gating, media delivery, credits UX
**Было (P0/P1):**
- Webhook падал с 500 из‑за попыток обращаться к `correlation_id` на `telegram.Update` (slots), без гарантированного fallback‑ответа пользователю.
- KIE stub включался в проде по умолчанию, если не задан `ALLOW_REAL_GENERATION`/`KIE_ALLOW_REAL`.
- Telegram отдавал `Wrong type of the web page content` при отправке медиа по URL (часть моделей ломала доставку).
- KIE credits ходил на `/api/v1/account/balance` и получал 404 без явного UX‑сообщения.
- Ошибки `state=fail` не показывали `failCode/failMsg` в логах и сообщениях, стадийные логи не фиксировали duration для create/poll/parse/send.

**Стало:**
- Webhook логирует correlation_id через contextvars, не мутирует Update и всегда ACK=200; при ошибке обработчика отправляется fallback‑сообщение пользователю.
- Реальный KIE включается по умолчанию, если есть `KIE_API_KEY` и нет `TEST_MODE`/`KIE_STUB=1`; stub только по явному флагу.
- Telegram sender выбирает метод доставки по `ModelSpec.output_media_type`, делает URL→download fallback с content‑type guard, media‑group и size‑guard.
- KIE credits переехал на `/api/v1/chat/credit`, при 404 показывает “Баланс KIE недоступен (endpoint 404)” и пишет structured warning.
- Ошибки `state=fail` включают `failCode/failMsg` в structured logs и тексте пользователю; стадии create/poll/parse/send фиксируют duration.

**Root cause:**
- Ошибка корреляции в webhook и fallback‑обработка, неверные defaults по stub, слабый медиа‑детектор и устаревший endpoint balance.

**Файлы изменены:**
- `main_render.py`, `app/generations/telegram_sender.py`, `app/generations/universal_engine.py`, `app/integrations/kie_stub.py`
- `app/kie/kie_client.py`, `bot_kie.py`, `helpers.py`, `.dockerignore`
- `tests/test_webhook_handler_smoke.py`, `tests/test_kie_stub_env_logic.py`, `tests/test_telegram_sender_media.py`
- `TRT_REPORT.md`

**Как проверил:**
- `python scripts/verify_project.py`
- `pytest -q`

**Как проверить вручную (Telegram):**
1. `/start` → выбрать модель → отправить промпт → убедиться, что медиа доставляется корректным типом (фото/видео/аудио).
2. Админ → “Панель администратора” → убедиться, что баланс KIE отображается или “Баланс KIE недоступен (endpoint 404)”.
3. Спровоцировать ошибку генерации (например, некорректные параметры) → увидеть `failCode/failMsg` и correlation_id в сообщении.
4. Проверить webhook‑режим: отправить update и убедиться, что ответ всегда 200 и пользователь получает fallback при ошибке.

## 2026-01-19: P0/P1 fixes — balance, payment flow, session reset
**Было:**
- Кнопка “Баланс” падала при отсутствии `get_credits()` у KIE клиента.
- `pay_sbp:*` уходил в UNKNOWN_CALLBACK и сбрасывал пользователя в меню.
- PTBUserWarning фиксировал возврат state=3, неизвестный текущему ConversationHandler.
- “Грязные сессии”: ожидание `payment_screenshot` конфликтовало с меню/моделью.

**Стало:**
- Баланс показывает внутренние RUB всегда; KIE credits — best‑effort без падений и с нейтральным текстом.
- `pay_sbp:*` и `pay_card:*` маршрутизируются корректно и поддерживаются из MENU при валидной сессии.
- Возвраты из button_callback ограничены валидными state keys (без PTBUserWarning).
- Введён единый reset при навигации: очищает хвосты сценариев при переходе в меню/модели/баланс/реферальную информацию.

**Root cause:**
- В клиенте KIE отсутствовал `get_credits()`, а payment callback не был зарегистрирован в роутере/known patterns.

**Файлы изменены:**
- `app/kie/kie_client.py`, `helpers.py`, `bot_kie.py`
- `tests/test_balance_kie_safe.py`, `tests/test_payment_flow_sbp.py`, `tests/test_navigation_resets_session.py`, `tests/test_callbacks_routing.py`
- `TRT_REPORT.md`

**Статус:**
- payment flow OK
- balance OK
- no unknown_callback
- no PTBUserWarning

**Как проверил:**
- `pytest tests/test_balance_kie_safe.py tests/test_payment_flow_sbp.py tests/test_navigation_resets_session.py tests/test_callbacks_routing.py`

## 2025-02-16: Production-ready generation pipeline (stub/real, media, logs, tests)
**Было:**
- KIE stub возвращал `state=completed` и `resultJson.urls`, что ломало `universal_engine` (ожидает `state=success` и `resultUrls`).
- Реальный KIE выключался из-за дефолта `KIE_STUB=1`, что оставляло прод на stub.
- `wait_for_task()` ожидал только `completed`, из-за чего `success` не завершал poll.
- Парсер результатов плохо различал text/image/video/audio и не логировал структурно пустые ответы.
- UX после подтверждения мог быть «тихим» до финального результата.

**Стало:**
- Stub возвращает `state=success` и корректный `resultJson` (urls/text) + структурные логи.
- Реальный KIE используется только при `KIE_ALLOW_REAL=1`/`ALLOW_REAL_GENERATION=1` и наличии `KIE_API_KEY`; stub включается явно.
- `wait_for_task()` обрабатывает `success`/`completed`.
- Парсер результата определяет media type по данным/SSOT, поддерживает text/image/video/audio/voice/document, логирует пустые ответы с `error_code`.
- После confirm пользователь сразу получает «✅ Принято / Генерирую…», плюс структурные логи по всем этапам (create/poll/parse/tg).

**Root cause:**
- Несоответствие контрактов stub ↔ universal_engine и дефолтный `KIE_STUB=1` скрывали реальный KIE, а poll ждал неверное состояние.

**Файлы изменены:**
- `app/integrations/kie_stub.py`, `app/kie/kie_client.py`, `app/generations/universal_engine.py`, `app/generations/telegram_sender.py`
- `app/observability/error_catalog.py`, `main_render.py`, `bot_kie.py`
- `tests/test_kie_stub_success.py`, `tests/test_generation_modalities_flow.py`, `tests/test_universal_engine_ssot.py`
- `TRT_REPORT.md`

**Как проверил:**
- `python scripts/verify_project.py`
- `pytest -q`

## 2025-02-16: P0/P1 hardening (trace, callbacks, async balance, dedup, KIE e2e)
**Было:**
- `trace_event()` падал на дублирующемся `stage` → ломал `answerCallbackQuery` и UX.
- Callback data с двоеточием в значении (`set_param:aspect_ratio:9:16`) разбивался неправильно в парсере.
- `check_balance` и другие async пути дергали sync‑обертки, что приводило к `RuntimeError` в event loop.
- UNKNOWN_CALLBACK молча уводил в меню без структурного лога и fix_hint.
- Повторные update_id могли дублировать `/start` и callback цепочки.
- Шумный `CATALOG_CACHE hit` в INFO.

**Стало:**
- `trace_event()` теперь best‑effort, не пробрасывает исключения, корректно принимает `stage` без дублей.
- Все разборы callback data используют `split(..., maxsplit=...)`; колоны в значении не ломают парсер.
- Баланс/лимиты теперь получают данные через async путь без sync‑wrapper.
- UNKNOWN_CALLBACK отвечает пользователю и пишет structured log с `fix_hint`.
- Введён TTL‑dedup по `update_id` (outcome=deduped) для защиты от повторов.
- `CATALOG_CACHE hit` переведён в DEBUG.

**Покрытие тестами:**
- `tests/ux/test_z_image_aspect_ratio_flow.py` — callback с `9:16` (не уходит в UNKNOWN_CALLBACK).
- `tests/test_check_balance_button.py` — кнопка баланса без `SYNC_WRAPPER_CALLED_IN_ASYNC`.
- `tests/test_kie_job_runner_e2e.py` — 5 e2e кейсов KIE (image/video/audio/stt/photo enhancement).

**Как проверил:**
- `pytest -q`

## 2025-02-16: P0 webhook ACK + correlation via contextvars
**Проблема:**
- `/webhook` падал с 500 из‑за `object.__setattr__(update, "correlation_id", ...)` на `telegram.Update` (slots).
- При падении PTB обработчика Telegram ретраил webhook → UX «молчит».

**Исправления:**
- Убрано добавление атрибутов в `Update`. Корреляция теперь хранится в contextvars (request‑scoped) и доступна через `app.observability.trace.get_correlation_id()`.
- `/webhook` всегда возвращает 200 при валидном JSON и корректном секрет‑токене, даже если PTB обработка упала.
- Добавлено логирование цепочки `update_received → forwarded_to_ptb (queued) → handler_outcome` без падений.

**Как проверить:**
- `python scripts/verify_project.py`
- `pytest -q` (есть тест webhook ACK: POST /webhook ⇒ 200 + лог `forwarded_to_ptb`).

## Что нашёл в коммитах (последние 3 дня)
- `app/kie_catalog/models_pricing.yaml` — расширения прайс-таблицы (commit `0ea378e5`, см. `git diff 0ea378e5^ 0ea378e5`).
- Серия коммитов 2026-01-17 затрагивала startup/handlers/logging, но прайс/реестр моделей в корне остаётся `models/kie_models.yaml` + `app/kie_catalog/models_pricing.yaml`.

## Файлы — source of truth (registry / pricing / menu / config)
1. `models/kie_models.yaml`
   - Зачем: **registry** моделей (model_type + input) — канонический источник модели и параметров.
   - Кто читает: `app/models/yaml_registry.py` → `app/models/registry.py`.
   - Этап: **startup** (проверка + загрузка) и далее для меню/маршрутов.

2. `app/kie_catalog/models_pricing.yaml`
   - Зачем: **pricing catalog** (официальные цены в USD, credits, типы моделей).
   - Кто читает: `app/kie_catalog/catalog.py` и `app/services/pricing_service.py`.
   - Этап: **startup** (проверка) и далее для карточек и цены.

3. `pricing/config.yaml` (fallback `pricing/config.json`)
   - Зачем: **курс и мультипликатор** для RUB (usd_to_rub, markup_multiplier).
   - Кто читает: `pricing/engine.py` → `app/config.py`.
   - Этап: **startup** (чтение настроек в Settings).

4. Меню
   - Меню строится из registry + pricing: `app/helpers/models_menu.py`, `app/helpers/models_menu_handlers.py`.
   - Каталог берётся из `app/kie_catalog/models_pricing.yaml`, параметры модели — из `models/kie_models.yaml`.

## Bisect (GOOD/BAD)
- Использован `git bisect` (GOOD=`4b111def`, BAD=`HEAD`) с проверкой на регрессию источника моделей и fallback-каллаbacks.
- По результату `git bisect` первый BAD определён как `e9378870a66f65266643f91a78c34fa7938d1704`.
- Дальнейшее уточнение требует полноценного runtime-теста (`/start` + callback) с .env.

## Было → Стало
- **Было:** главное меню ломало HTML при чанкинге и иногда отправлялось без parse_mode.
- **Стало:** HTML-чанки нормализуются (баланс тегов, закрытие/переоткрытие), parse_mode всегда HTML.
- **Было:** первое сообщение /start могло быть перегружено рамками и длинными секциями, клавиатура терялась среди чанков.
- **Стало:** первый экран = короткий welcome + клавиатура; подробности уходят отдельными сообщениями без клавиатуры.
- **Было:** input_parameters мог доходить до конца без ответа (NO-SILENCE violation при waiting_for=prompt).
- **Стало:** для prompt всегда есть ответ (валидация, сохранение, переход к следующему шагу), fallback guard прикрывает тишину.
- **Было:** GitHubStorage держал общие aiohttp-сессии между loop, что приводило к `session_detached`/`loop_mismatch`.
- **Стало:** GitHubStorage использует управляемую сессию с проверкой loop mismatch и явным закрытием на shutdown; метрики чтения/записи включают latency.
- **Было:** optional параметры могли не иметь кнопки “Пропустить/по умолчанию”, а подсказки обещали кнопку, которой нет.
- **Стало:** для optional enum/boolean/text добавлены кнопки “Использовать по умолчанию” или “Пропустить (auto)” с корректными подсказками.
- **Было:** image→video модели начинали с prompt, из-за чего prompt мог не запрашиваться после фото.
- **Стало:** порядок первого ввода определяется по model_type + schema (image→video сначала фото, text→video сначала prompt, audio сначала файл).
- **П1:** language selection не включён в handlers; default=ru, запись языка только при явном выборе пользователем.

## Как проверил
- `pytest -q`

## Какие файлы тронул
- `app/storage/github_storage.py`
- `bot_kie.py`
- `tests/test_parameter_buttons.py`
- `scripts/kie_smoke.py`
- `TRT_REPORT.md`

## Почему теперь не отвалится в webhook режиме
- `create_application()` в `app/bootstrap.py` сразу после `Application.builder().build()` вызывает `ensure_error_handler_registered()`, поэтому webhook-строитель всегда получает error handler.
- `app/main.py` и `bot_kie.py` используют тот же инвариант, чтобы исключить путь запуска без error handler.

## Логи (до / после)
**До:**
- `📊 models_registry source=unknown count=...`
- `PRICE_RUB=... MULT=... RATE=100.0 ...`
- `MAIN_MENU_SHOWN source=unknown_callback_handler`

**После (ожидаемо):**
- `✅ SOURCE OF TRUTH: registry=/workspace/TRT/models/kie_models.yaml models=... | pricing_catalog=/workspace/TRT/app/kie_catalog/models_pricing.yaml models=... | pricing_settings=/workspace/TRT/pricing/config.yaml | usd_to_rub=77.2222 | price_multiplier=2.0`
- `📊 models_registry source=yaml path=/workspace/TRT/models/kie_models.yaml count=...`
- `MAIN_MENU_SHOWN source=gen_type` (fallback не используется)

## PTB ConversationHandler warning
- В коде ConversationHandler использует `per_message=False` (default) и включает `CallbackQueryHandler` + `MessageHandler` для текстовых/медиа шагов. Это вызывает PTBUserWarning:
  - `If 'per_message=False', 'CallbackQueryHandler' will not be tracked for every message`.
- Это безопасно для текущего UX, потому что состояние ведётся по `per_chat` и сообщения/кнопки ожидаются в рамках чата пользователя.
- Исправление через `per_message=True` невозможно без удаления MessageHandler из ConversationHandler (сломает ввод текста/медиа). Поэтому warning задокументирован как допустимый компромисс.

## Runbook: локальный Render-mode smoke (без секретов)
1. Убедитесь, что `python` доступен, затем:
   - `python scripts/render_webhook_smoke.py`
2. Скрипт стартует `main_render.py` в `BOT_MODE=webhook`, поднимает health server, вызывает `/health` и `/webhook`.
   - Для sandbox/CI используется `SMOKE_NO_PROCESS=1` (skip Telegram init, без внешнего сетевого вызова).
3. Ожидаемый результат:
   - `status=ok` в JSON ответа `/health`
   - `webhook_route_registered=true` в JSON ответа
   - `/webhook` возвращает 200/204

## Runbook: верификация на Render
1. Deploy текущей ветки.
2. В Render logs найти маркеры:
   - `[HEALTH] server_listening=true port=...`
   - `[WEBHOOK] route_registered=true`
   - `[RUN] webhook_set_ok=true` (если не используется WEBHOOK_SKIP_SET)
   - `POST /webhook status=200` (при ручном тесте)
   - отсутствие `HTML chunk invalid`
   - отсутствие `NO-SILENCE VIOLATION`
   - отсутствие `Unclosed client session`
3. Проверить `/health` = 200 и JSON содержит `webhook_route_registered=true`.

## Что не проверено в этой среде
- Реальные Render логи и Telegram-сценарии: требуется доступ к Render/Telegram с .env (секреты не доступны в sandbox).

## 2025-02-14: UX contract + safe KIE mode + structured callback log
**Было:**
- Не было формального UX/State/Log контрактов в docs/.
- KIE stub включался только при явном `KIE_STUB=1`.
- Structured log для callback был неформализован.

**Стало:**
- Добавлены UX/State/Log контракты в `docs/` как соглашение для дальнейшей реализации.
- Safe-mode для KIE: по умолчанию используется stub, реальный режим только при `KIE_ALLOW_REAL=1`.
- Добавлен structured callback log (correlation_id/action_path/waiting_for/param/outcome).

**Причина:**
- Зафиксировать UX как контракт и обеспечить безопасный режим интеграций по умолчанию.

**Как проверил:**
- `pytest -q`

**Что осталось:**
- Интегрировать router parse→validate→route→execute→respond→log во все callback-ветки.
- Доработать тесты UX/лог-контрактов по списку в задании.

## 2025-02-14: Wizard UX для input_parameters + параметры/назад
**Было:**
- После prompt для не z-image моделей цепочка параметров обрывалась: следующий шаг не показывался, логировалось `input_parameters reached end without response`.
- NO-SILENCE guard выдавал ложный warning даже при наличии исходящих ответов.
- Back возвращал в начало с удалением параметров, отсутствовал стек истории.
- На confirmation не было единой кнопки для просмотра/изменения всех параметров.
- Текст “не вовремя” отвечал общим “Я не жду текст сейчас” без контекстных подсказок.

**Стало:**
- Исправлено ветвление в `input_parameters`: после установки параметра всегда переход к следующему шагу или подтверждению; special-case z-image больше не захватывает общий флоу.
- NO-SILENCE guard в конце `input_parameters` больше не логирует нарушение при `outgoing_count > 0`.
- Реализован `param_history` стек: push при вводе параметров, pop при `back_to_previous_step` для корректного возврата.
- Добавлена кнопка “⚙️ Параметры” на экране подтверждения, список параметров с текущими значениями и быстрым редактированием.
- Для “текста не вовремя” показывается контекстная подсказка с кнопками продолжения и примером действия.

**Причина:**
- Устранить прод-симптомы из логов и сделать ввод параметров “невозможно сломать”.

**Как проверил:**
- `pytest`

**Какие файлы тронул:**
- `bot_kie.py`
- `tests/test_input_parameters_wizard_flow.py`

## 2025-02-15: Callback crash fix + single main menu UX
**Причина бага:**
- `NameError: is_admin_user is not defined` при обработке `set_param` → `calculate_price_rub` (отсутствовала инициализация is_admin_user перед расчетом цены).

**Где исправил:**
- `bot_kie.py` в обработчике `set_param` добавлено `is_admin_user = get_is_admin(user_id)` перед `calculate_price_rub` и сброс `waiting_for` после ввода последнего параметра.

**Как устранил “второе меню”:**
- `show_main_menu` теперь отправляет только одно сообщение с welcome + клавиатурой (без вторичных release/what's new карточек).
- `unknown_callback_handler` и fallback в `button_callback` отвечают коротким сообщением и редактируют текущее сообщение в главное меню без дополнительных карточек.

**Как проверил:**
- Команды: `python scripts/verify_project.py`, `pytest -q`.
- UX шаги (через harness): `/start -> gen_type:text-to-image -> select_model:z-image -> prompt -> set_param:aspect_ratio:1:1` — без исключений, подтверждение генерации отображается, главное меню не дублируется.

**Какие файлы тронул:**
- `bot_kie.py`
- `tests/test_main_menu.py`
- `tests/ux/test_z_image_aspect_ratio_flow.py`
- `TRT_REPORT.md`

## 2025-02-15: Универсальный engine + SSOT coverage (72 модели)
**Сделано:**
- Введён единый ModelSpec, собираемый из SSOT (`models/kie_models.yaml` + `app/kie_catalog/models_pricing.yaml`), с полями schema/output_media_type.
- Wizard/engine/payload используют единый pipeline без хардкодов под одну модель.
- Унифицированный parser результата и отправка в Telegram по `media_type`.

**Покрытие по моделям:**
- Авто-smoke проверяет 72/72 моделей (schema + payload build).
- Media buckets: image, video, audio, voice, text покрыты мок-тестами.

**Ручные проверки:**
- В этой среде не выполнялись (нет доступа к Telegram/KIE).

**Как проверил:**
- `python scripts/verify_project.py`
- `pytest -q`

## 2025-02-15: ABSOLUTE TRACEABILITY (corr-id + stages)
**Было:**
- Корреляция между UI → KIE → TG отсутствовала, TRACE_IN/TRACE_OUT не гарантировались.
- PRICE_RUB логировался дублирующе при каждом расчёте.
- Ошибки не имели единой taxonomy/fix_hint.

**Стало:**
- Добавлен unified trace logger: `app/observability/trace.py` (corr-id, TRACE_IN/OUT, stage + duration). 
- Корреляция прокидывается в UI/SESSION/KIE/TG пайплайн; ключевые стадии: `UI_ROUTER`, `SESSION_LOAD`, `STATE_VALIDATE`, `PRICE_CALC`, `KIE_CREATE`, `KIE_POLL`, `KIE_PARSE`, `TG_DELIVER`.
- Telegram delivery вынесен в `deliver_result()` с логированием типа медиа, метода отправки и fallback.
- Цена логируется только в `select_model` и финальном подтверждении; дублирование устранено.
- Добавлен каталог ошибок `app/observability/error_catalog.py` и структурированный `trace_error` в error handler.

**Как включать детализацию:**
- `LOG_LEVEL=DEBUG` — stacktrace в trace_error и больше деталей.
- `TRACE_VERBOSE=true` — расширенные поля в trace_event.
- `TRACE_PAYLOADS=false` — не логирует сырые prompt/media (только len/hash).
- `TRACE_PRICING=true` — детальнее price-каталог.

**Пример поиска по корреляции:**
- `grep "corr-<update_id>-<user_id>" render.log`

**Как проверил:**
- `python scripts/verify_project.py`
- `pytest -q`

## 2025-02-14: P0 set_trace_context + TRACE unification + catalog cache

### STEP 0 — FULL AUDIT
**Где вызывался guard.set_trace_context:**
- `bot_kie.py` → `button_callback` (≈L3320).
- `bot_kie.py` → `input_parameters` (≈L9761).
- `bot_kie.py` → `confirm_generation` (≈L12492).
- `bot_kie.py` → `unknown_callback_handler` (≈L25738).

**Текущая сигнатура NoSilenceGuard.set_trace_context:**
- `app/observability/no_silence_guard.py`:
  `def set_trace_context(self, *, user_id, chat_id, update_id, message_id=None, update_type=None, correlation_id=None, **extra)`

**Где update_id передавался дважды (и падал на бою):**
- `button_callback`: `guard.set_trace_context(update_id, correlation_id, update_id=update_id, ...)` — позиционный + keyword.
- `input_parameters`: `guard.set_trace_context(update_id, correlation_id, update_id=update_id, ...)` — позиционный + keyword.
- `confirm_generation` и `unknown_callback_handler` — аналогичный паттерн.

**Почему тесты не ловили:**
- Большинство unit-тестов вызывали обработчики напрямую или через harness без реального callback→input потока, поэтому конфликт аргументов возникал только при боевом пути Telegram callback + message (Render webhook), где вызывался `button_callback`/`input_parameters` с positional+keyword аргументами.

**Какие пути боевые падали:**
- Любой callback → `button_callback` или вход текста → `input_parameters`, когда `update_id` передавался дважды.
- На Render это проявлялось при клике любой кнопки (callback) и при вводе параметра (message).

### STEP 1 — FIX P0
- `set_trace_context` переведён на keyword-only и все вызовы исправлены на именованные аргументы.
- Исключены все дубли `update_id` (позиционный + keyword).

### STEP 2 — TESTS
- Добавлен e2e тест: `/start -> callback gen_type:text-to-image -> callback select_model:z-image -> user sends prompt`.
- Добавлен тест на `set_trace_context` с keyword-only вызовом.

### STEP 3 — TRACE UNIFICATION
- `TRACE_VERBOSE`, `TRACE_PAYLOADS`, `TRACE_PRICING` подключены в `trace_event`.
- Корреляция: webhook correlation_id теперь пробрасывается в PTB handlers через `update.correlation_id`.
- Все логи `🔥🔥🔥` переведены на DEBUG.

### STEP 4 — PERFORMANCE
- Добавлен process-level cache по mtime ключу для каталога `models_pricing.yaml` + registry `models/kie_models.yaml`.
- Логируются `CATALOG_CACHE hit/miss + load_ms`.
- `get_free_model_ids()` использует кеш `load_catalog()`.

### STEP 7 — REPORT + PROOF
**Как включить расширенные логи:**
- `LOG_LEVEL=DEBUG`
- `TRACE_VERBOSE=true`
- `TRACE_PAYLOADS=true` (если нужно видеть payload)
- `TRACE_PRICING=true` (если нужно видеть цены)

**grep по correlation_id:**
- `rg "correlation_id=<id>" -n`

**E2E ручные сценарии (10 кликов):**
1. `/start` → главное меню
2. `gen_type:text-to-image` → список моделей
3. `select_model:z-image` → запрос prompt
4. Ввести prompt → запрос следующего параметра
5. `back_to_previous_step` → возврат шага
6. `back_to_menu` → сброс сессии и главное меню
7. `free_tools` → список бесплатных
8. `help_menu` → справка
9. `check_balance` → баланс
10. `generate_again` → повтор генерации

### STEP 8 — ROUTING + FALLBACK HARDENING
- **Root cause:** generic text handlers/fallback intercepted messages before the generation flow, and `unhandled_update_fallback` referenced `model_info`/`params` that were undefined, causing NameError crashes.
- **Fix:** added an early active-session router (SessionStore-based) to send active `waiting_for/current_param` messages into `input_parameters`, reordered handlers so the ConversationHandler precedes generic text handlers, and rewrote `unhandled_update_fallback` to only show main menu/help or relay “waiting for param” without undefined variables.
- **How to verify:** check logs for `ROUTE_DECISION` lines with `waiting_for` and `chosen_handler` plus fallback `FIX_HINT` guidance; active sessions should log `active_session_router->input_parameters` and no longer emit `UNHANDLED_UPDATE` for prompt text.
